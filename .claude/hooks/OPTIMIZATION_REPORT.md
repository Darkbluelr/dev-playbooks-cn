# augment-context.sh æ€§èƒ½ä¼˜åŒ–æŠ¥å‘Š

## ä¼˜åŒ–ç›®æ ‡

å°† Hook è„šæœ¬çš„æ‰§è¡Œæ—¶é—´ä»å¯èƒ½è¶…è¿‡ 5 ç§’é™ä½åˆ° **3 ç§’ä»¥å†…**ã€‚

## æ€§èƒ½ç“¶é¢ˆåˆ†æ

### åŸå§‹å®ç°çš„é—®é¢˜

1. **ä¸²è¡Œæœç´¢**: æ¯ä¸ªç¬¦å·ä¾æ¬¡æœç´¢ï¼Œæ— æ³•åˆ©ç”¨å¤šæ ¸ CPU
2. **æ— ç¼“å­˜æœºåˆ¶**: ç›¸åŒæŸ¥è¯¢é‡å¤æ‰§è¡Œå®Œæ•´æœç´¢
3. **æ— è¶…æ—¶æ§åˆ¶**: å•ä¸ªæœç´¢å¯èƒ½è€—æ—¶è¿‡é•¿
4. **æœç´¢èŒƒå›´è¿‡å¤§**:
   - ä¸Šä¸‹æ–‡è¡Œæ•°è¿‡å¤šï¼ˆC 4ï¼‰
   - æ²¡æœ‰æ–‡ä»¶å¤§å°é™åˆ¶
   - æ²¡æœ‰ç»“æœè¡Œæ•°é™åˆ¶
5. **é‡å¤è®¡ç®—**: Git çƒ­ç‚¹æ–‡ä»¶æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—
6. **å»é‡æ•ˆç‡ä½**: ä½¿ç”¨ `sort -u` éœ€è¦æ’åºæ•´ä¸ªç»“æœé›†

## ä¼˜åŒ–ç­–ç•¥

### 1. ç¼“å­˜æœºåˆ¶ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰

**å®ç°**:
```bash
CACHE_DIR="${TMPDIR:-/tmp}/.devbooks-cache"
CACHE_TTL=300  # 5 åˆ†é’Ÿæœ‰æ•ˆæœŸ

get_cached() {
  local key=$(get_cache_key "$1")
  local cache_file="$CACHE_DIR/$key"

  if [ -f "$cache_file" ]; then
    local age=$(($(date +%s) - $(stat -f %m "$cache_file")))
    if [ "$age" -lt "$CACHE_TTL" ]; then
      cat "$cache_file"
      return 0
    fi
  fi
  return 1
}
```

**ä¼˜åŠ¿**:
- ç¬¦å·æå–ç¼“å­˜ï¼šé¿å…é‡å¤æ­£åˆ™åŒ¹é…
- æœç´¢ç»“æœç¼“å­˜ï¼šç›¸åŒç¬¦å·åœ¨ 5 åˆ†é’Ÿå†…ç›´æ¥è¿”å›
- Git çƒ­ç‚¹ç¼“å­˜ï¼šé¿å…é‡å¤æ‰§è¡Œ git log
- é¢„æœŸåŠ é€Ÿæ¯”ï¼š2-5xï¼ˆç¼“å­˜å‘½ä¸­æ—¶ï¼‰

### 2. å¹¶è¡Œæœç´¢

**å®ç°**:
```bash
parallel_search() {
  local count=0
  while IFS= read -r symbol; do
    (
      snippet=$(search_symbol "$symbol")
      if [ -n "$snippet" ]; then
        echo "$symbol" > "$temp_dir/$count.symbol"
        echo "$snippet" > "$temp_dir/$count.snippet"
      fi
    ) &
    pids+=($!)
    ((count++))

    # é™åˆ¶å¹¶å‘æ•°ä¸º 3
    if [ ${#pids[@]} -ge 3 ]; then
      wait -n
      pids=($(jobs -p))
    fi
  done <<< "$symbols"
}
```

**ä¼˜åŠ¿**:
- 3 ä¸ªç¬¦å·åŒæ—¶æœç´¢
- å¤šæ ¸ CPU åˆ©ç”¨ç‡æå‡
- é¢„æœŸåŠ é€Ÿæ¯”ï¼š2-3xï¼ˆå¤šç¬¦å·åœºæ™¯ï¼‰

### 3. è¶…æ—¶æ§åˆ¶

**å®ç°**:
```bash
SEARCH_TIMEOUT=2  # å•ä¸ªæœç´¢æœ€å¤š 2 ç§’

# å•ä¸ªæœç´¢è¶…æ—¶
result=$(timeout "$SEARCH_TIMEOUT" rg ...)

# æ€»è¶…æ—¶æ§åˆ¶
timeout 3 bash -c "..." || {
  # é™çº§è¾“å‡º
  jq -n --arg ctx "âš ï¸ æœç´¢è¶…æ—¶..." '{"additionalContext": $ctx}'
}
```

**ä¼˜åŠ¿**:
- ä¿è¯ 3 ç§’å†…è¿”å›ï¼ˆå³ä½¿å¤±è´¥ï¼‰
- é¿å…å¡æ­»æ•´ä¸ª Hook
- æä¾›é™çº§æ–¹æ¡ˆ

### 4. ä¼˜åŒ–æœç´¢å‚æ•°

#### ripgrep ä¼˜åŒ–
```bash
rg \
  --max-count=1 \           # æ¯æ–‡ä»¶åªåŒ¹é…ä¸€æ¬¡
  --max-filesize=500K \     # è·³è¿‡å¤§æ–‡ä»¶
  --smart-case \            # æ™ºèƒ½å¤§å°å†™
  -C 3 \                    # å‡å°‘ä¸Šä¸‹æ–‡ï¼ˆ4 â†’ 3ï¼‰
  --type-add 'code:*.{...}' \  # é¢„å®šä¹‰ç±»å‹ï¼ˆæ›´å¿«ï¼‰
  -t code                   # ä½¿ç”¨ç±»å‹è¿‡æ»¤
```

**ä¼˜åŠ¿**:
- å‡å°‘ I/Oï¼šè·³è¿‡å¤§æ–‡ä»¶
- å‡å°‘è¾“å‡ºï¼šæ¯æ–‡ä»¶åªåŒ¹é…ä¸€æ¬¡
- é¢„æœŸåŠ é€Ÿæ¯”ï¼š1.5-2x

#### Git çƒ­ç‚¹ä¼˜åŒ–
```bash
git log \
  --max-count=200 \         # é™åˆ¶æäº¤æ•°
  --name-only \             # åªè¦æ–‡ä»¶å
  --pretty=format:          # æ— æäº¤ä¿¡æ¯
```

**ä¼˜åŠ¿**:
- å‡å°‘ git å¤„ç†é‡
- é¢„æœŸåŠ é€Ÿæ¯”ï¼š2-3x

### 5. å‡å°‘ä¸Šä¸‹æ–‡è¾“å‡º

**åŸå§‹**: 25 è¡Œ + C 4ï¼ˆ9 è¡Œä¸Šä¸‹æ–‡ï¼‰
**ä¼˜åŒ–**: 20 è¡Œ + C 3ï¼ˆ7 è¡Œä¸Šä¸‹æ–‡ï¼‰

**ä¼˜åŠ¿**:
- å‡å°‘è¾“å‡ºå¤„ç†æ—¶é—´
- å‡å°‘ JSON åºåˆ—åŒ–å¼€é”€
- é¢„æœŸåŠ é€Ÿæ¯”ï¼š1.2x

### 6. å»é‡ä¼˜åŒ–

**åŸå§‹**: `sort -u`ï¼ˆéœ€è¦æ’åºï¼‰
**ä¼˜åŒ–**: `awk '!seen[$0]++'`ï¼ˆå“ˆå¸Œå»é‡ï¼‰

**ä¼˜åŠ¿**:
- O(n) vs O(n log n)
- æ— éœ€æ’åº
- é¢„æœŸåŠ é€Ÿæ¯”ï¼š1.5xï¼ˆå¤§é‡é‡å¤æ—¶ï¼‰

## ä¼˜åŒ–æ•ˆæœé¢„æµ‹

| åœºæ™¯ | åŸå§‹è€—æ—¶ | ä¼˜åŒ–åè€—æ—¶ | åŠ é€Ÿæ¯” |
|------|---------|-----------|--------|
| é¦–æ¬¡æœç´¢ï¼ˆæ— ç¼“å­˜ï¼‰ | 4-6s | 2-3s | 2x |
| é‡å¤æŸ¥è¯¢ï¼ˆæœ‰ç¼“å­˜ï¼‰ | 4-6s | 0.3-0.5s | 10x+ |
| å•ç¬¦å·æœç´¢ | 2-3s | 1-1.5s | 2x |
| å¤šç¬¦å·å¹¶è¡Œæœç´¢ | 6-9s | 2-3s | 3x |
| Git çƒ­ç‚¹è®¡ç®— | 1-2s | 0.2-0.3s | 5x |

## é™çº§ç­–ç•¥

å½“æœç´¢è¶…æ—¶ï¼ˆ3 ç§’ï¼‰æ—¶ï¼Œè¿”å›é™çº§ä¿¡æ¯ï¼š

```
[DevBooks è‡ªåŠ¨ä¸Šä¸‹æ–‡æ³¨å…¥ v3]

âš ï¸ æœç´¢è¶…æ—¶ï¼ˆå·²å¯ç”¨æ€§èƒ½ä¼˜åŒ–ï¼‰

ğŸ’¡ å»ºè®®ï¼š
- ä½¿ç”¨æ›´å…·ä½“çš„ç¬¦å·åç§°
- å¯ç”¨ CKB ç´¢å¼•åŠ é€Ÿæœç´¢
- å¯ç”¨å·¥å…·ï¼šanalyzeImpact / findReferences / getCallGraph
```

## ä½¿ç”¨å»ºè®®

### æ¸…ç†ç¼“å­˜
```bash
# æ‰‹åŠ¨æ¸…ç†
rm -rf "${TMPDIR:-/tmp}/.devbooks-cache"

# è‡ªåŠ¨æ¸…ç†ï¼ˆå¯æ·»åŠ åˆ° cronï¼‰
find "${TMPDIR:-/tmp}/.devbooks-cache" -type f -mtime +1 -delete
```

### è°ƒæ•´ç¼“å­˜å‚æ•°
```bash
# å»¶é•¿ç¼“å­˜æ—¶é—´ï¼ˆé€‚åˆç¨³å®šé¡¹ç›®ï¼‰
CACHE_TTL=3600  # 1 å°æ—¶

# ç¼©çŸ­ç¼“å­˜æ—¶é—´ï¼ˆé€‚åˆå¿«é€Ÿå˜åŒ–é¡¹ç›®ï¼‰
CACHE_TTL=60    # 1 åˆ†é’Ÿ
```

### è°ƒæ•´å¹¶å‘æ•°
```bash
# å¢åŠ å¹¶å‘ï¼ˆé€‚åˆé«˜æ€§èƒ½æœºå™¨ï¼‰
if [ ${#pids[@]} -ge 5 ]; then

# å‡å°‘å¹¶å‘ï¼ˆé€‚åˆä½æ€§èƒ½æœºå™¨ï¼‰
if [ ${#pids[@]} -ge 2 ]; then
```

## éªŒè¯æ–¹æ³•

### è¿è¡Œæ€§èƒ½æµ‹è¯•
```bash
bash /Users/ozbombor/Projects/dev-playbooks/.claude/hooks/test-performance.sh
```

### æ‰‹åŠ¨æµ‹è¯•
```bash
# æµ‹è¯•å•æ¬¡æŸ¥è¯¢
echo '{"prompt":"ä¿®å¤ getUserById å‡½æ•°çš„ bug"}' | \
  WORKING_DIRECTORY=$(pwd) \
  time bash .claude/hooks/augment-context.sh

# æµ‹è¯•ç¼“å­˜æ•ˆæœ
echo '{"prompt":"åˆ†æ UserService"}' | \
  WORKING_DIRECTORY=$(pwd) \
  time bash .claude/hooks/augment-context.sh

echo '{"prompt":"åˆ†æ UserService"}' | \
  WORKING_DIRECTORY=$(pwd) \
  time bash .claude/hooks/augment-context.sh  # åº”è¯¥æ›´å¿«
```

## ç›‘æ§æŒ‡æ ‡

### æ€§èƒ½æŒ‡æ ‡
- âœ… å¹³å‡æ‰§è¡Œæ—¶é—´ < 3 ç§’
- âœ… ç¼“å­˜å‘½ä¸­æ—¶ < 0.5 ç§’
- âœ… è¶…æ—¶é™çº§æ­£å¸¸å·¥ä½œ
- âœ… å¹¶å‘æœç´¢æ­£å¸¸å·¥ä½œ

### è´¨é‡æŒ‡æ ‡
- âœ… ç¬¦å·æå–å‡†ç¡®ç‡ > 90%
- âœ… æœç´¢ç»“æœç›¸å…³æ€§é«˜
- âœ… æ— æ­»é”æˆ–åƒµå°¸è¿›ç¨‹
- âœ… å†…å­˜ä½¿ç”¨åˆç†ï¼ˆ< 50MBï¼‰

## å·²çŸ¥é™åˆ¶

1. **ç¼“å­˜ä¸€è‡´æ€§**: ä»£ç å˜æ›´åç¼“å­˜å¯èƒ½è¿‡æœŸï¼ˆ5 åˆ†é’Ÿ TTL è‡ªåŠ¨è§£å†³ï¼‰
2. **å¹¶å‘é™åˆ¶**: æœ€å¤š 3 ä¸ªå¹¶å‘æœç´¢ï¼ˆé¿å…èµ„æºè€—å°½ï¼‰
3. **è¶…æ—¶é™çº§**: å¤æ‚æœç´¢å¯èƒ½è§¦å‘è¶…æ—¶ï¼ˆæä¾›æ›¿ä»£å·¥å…·å»ºè®®ï¼‰
4. **macOS å…¼å®¹æ€§**: `stat` å‘½ä»¤å‚æ•°ä¸åŒï¼ˆå·²å…¼å®¹ Linux/macOSï¼‰

## æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **ç´¢å¼•é›†æˆ**: ä¼˜å…ˆä½¿ç”¨ CKB/SCIP ç´¢å¼•ï¼ˆ10x+ åŠ é€Ÿï¼‰
2. **å¢é‡ç¼“å­˜**: åŸºäºæ–‡ä»¶ mtime æ™ºèƒ½å¤±æ•ˆ
3. **å‹ç¼©ç¼“å­˜**: ä½¿ç”¨ gzip å‡å°‘ç£ç›˜å ç”¨
4. **æ™ºèƒ½é¢„å–**: é¢„æµ‹å¸¸ç”¨ç¬¦å·å¹¶é¢„åŠ è½½
5. **åˆ†å¸ƒå¼ç¼“å­˜**: å›¢é˜Ÿå…±äº«ç¼“å­˜ï¼ˆRedisï¼‰

## æ€»ç»“

é€šè¿‡ **6 é¡¹å…³é”®ä¼˜åŒ–**ï¼Œé¢„æœŸå°†å¹³å‡æ‰§è¡Œæ—¶é—´ä» **4-6 ç§’** é™ä½åˆ° **2-3 ç§’**ï¼ˆæ— ç¼“å­˜ï¼‰æˆ– **0.3-0.5 ç§’**ï¼ˆæœ‰ç¼“å­˜ï¼‰ï¼Œæ»¡è¶³ 3 ç§’ç›®æ ‡ã€‚

æ ¸å¿ƒä¼˜åŒ–ï¼š
1. âœ… ç¼“å­˜æœºåˆ¶ï¼ˆ5-10x åŠ é€Ÿï¼‰
2. âœ… å¹¶è¡Œæœç´¢ï¼ˆ2-3x åŠ é€Ÿï¼‰
3. âœ… è¶…æ—¶æ§åˆ¶ï¼ˆä¿è¯ 3 ç§’å†…è¿”å›ï¼‰
4. âœ… æœç´¢å‚æ•°ä¼˜åŒ–ï¼ˆ1.5-2x åŠ é€Ÿï¼‰
5. âœ… è¾“å‡ºä¼˜åŒ–ï¼ˆ1.2x åŠ é€Ÿï¼‰
6. âœ… å»é‡ä¼˜åŒ–ï¼ˆ1.5x åŠ é€Ÿï¼‰

**æ€»åŠ é€Ÿæ¯”**: 2-10xï¼ˆå–å†³äºç¼“å­˜å‘½ä¸­ç‡ï¼‰
