---
name: devbooks-docs-sync
description: devbooks-docs-sync：维护项目文档（README、API 文档等面向用户的文档）与代码的一致性。支持增量模式（针对 change）和全局模式（一致性检查）。用户说"更新文档/同步文档/文档对齐/README 更新/API 文档更新"等时使用。
allowed-tools:
  - Glob
  - Grep
  - Read
  - Edit
  - Write
  - Bash
---

# DevBooks：文档同步（Docs Sync）

## 前置：配置发现（协议无关）

执行前**必须**按以下顺序查找配置（找到后停止）：
1. `.devbooks/config.yaml`（如存在）→ 解析并使用其中的映射
2. `dev-playbooks/project.md`（如存在）→ Dev-Playbooks 协议，使用默认映射
3. `project.md`（如存在）→ template 协议，使用默认映射
4. 若仍无法确定 → **停止并询问用户**

---

## 角色定义

**docs-sync** 是 DevBooks Apply 阶段的文档维护角色，负责确保面向用户的文档与代码保持一致。

### 文档分类

| 文档类型 | 目标受众 | 是否由本 Skill 维护 | 示例 |
|----------|----------|:-------------------:|------|
| **用户文档** | 最终用户 | ✅ | README.md, docs/*.md, API.md |
| **开发者规范** | AI/开发者 | ❌（由其他 skill 维护） | dev-playbooks/, AGENTS.md |
| **代码注释** | 开发者 | ❌（由 coder 维护） | JSDoc, 行内注释 |

### 与其他角色的区别

| 维度 | docs-sync | coder | reviewer |
|------|:---------:|:-----:|:--------:|
| 维护用户文档 | ✅ | ❌ | ❌ |
| 修改代码 | ❌ | ✅ | ❌ |
| 修改测试 | ❌ | ❌ | ❌ |
| 审查代码质量 | ❌ | ❌ | ✅ |

---

## 关键约束

### CON-DOCS-001：只维护用户文档
- **允许修改**：README.md、docs/、API.md、CHANGELOG.md、配置说明等
- **禁止修改**：dev-playbooks/、AGENTS.md、CLAUDE.md、src/、tests/

### CON-DOCS-002：不引入新功能
- 只同步现有功能的文档描述
- 不添加代码中不存在的功能说明
- 如发现功能缺失，应提出建议而非自行添加

### CON-DOCS-003：保持风格一致
- 遵循项目现有的文档风格
- 使用 `<truth-root>/_meta/glossary.md` 中的统一术语
- 保持中英文一致性（如项目有多语言文档）

---

## 运行模式

### 模式一：增量模式（Change-Scoped）

**触发条件**：在变更包上下文中运行

**行为**：
1. 分析本次 change 影响的公共 API/功能/配置
2. 定位相关的用户文档
3. 更新受影响的文档部分
4. 输出变更摘要

**执行流程**：
```
1. 读取 <change-root>/<change-id>/design.md 了解变更内容
2. 识别影响范围：
   - 新增/修改的公共 API
   - 配置项变更
   - 用户可见行为变更
3. 定位需要更新的文档：
   - README.md 中的功能说明
   - API.md 中的接口文档
   - docs/ 中的使用指南
4. 执行更新并记录
```

### 模式二：全局模式（Global Sync）

**触发条件**：用户显式请求全局同步（如 `devbooks-docs-sync --global`）

**行为**：
1. 扫描项目所有公共 API 和功能
2. 比对文档覆盖情况
3. 生成差异报告
4. 询问用户确认后执行修复

**执行流程**：
```
1. 扫描代码中的公共接口（导出函数、类、配置）
2. 扫描用户文档中的功能描述
3. 生成对比矩阵：
   - 代码有文档无：需要补充
   - 代码无文档有：过时文档
   - 代码文档不一致：需要同步
4. 输出差异报告
5. 用户确认后执行修复
```

---

## 检查清单

### 文档覆盖检查

- [ ] README.md 中的功能列表是否与实际功能一致
- [ ] API 文档是否覆盖所有公共接口
- [ ] 配置说明是否与实际配置项一致
- [ ] 示例代码是否能正常运行

### 一致性检查

- [ ] 文档中的术语是否与 glossary.md 一致
- [ ] 版本号是否与 package.json 一致
- [ ] 命令行示例是否与实际 CLI 一致
- [ ] 链接是否有效（无死链）

### 完整性检查

- [ ] 安装指南是否完整
- [ ] 快速开始是否可用
- [ ] 常见问题是否更新
- [ ] CHANGELOG 是否记录了重要变更

---

## 输出格式

### 增量模式输出

```markdown
# Docs Sync Report: <change-id>

## 影响分析

| 变更类型 | 影响项 | 相关文档 |
|----------|--------|----------|
| 新增 API | `createWidget()` | README.md, API.md |
| 修改配置 | `timeout` 参数 | docs/config.md |
| 移除功能 | `legacyMode` | README.md |

## 更新摘要

### README.md
- [x] 更新功能列表，添加 `createWidget` 描述
- [x] 移除 `legacyMode` 相关说明

### API.md
- [x] 添加 `createWidget()` 接口文档

## 结论

✅ **SYNCED** - 文档已同步完成
```

### 全局模式输出

```markdown
# Global Docs Sync Report

## 覆盖率统计

| 类型 | 代码数量 | 文档数量 | 覆盖率 |
|------|----------|----------|--------|
| 公共函数 | 25 | 22 | 88% |
| 配置项 | 10 | 10 | 100% |
| CLI 命令 | 5 | 4 | 80% |

## 差异清单

### 缺失文档（代码有文档无）
1. `parseConfig()` - src/config.ts:42
2. `validateInput()` - src/utils.ts:15

### 过时文档（代码无文档有）
1. `oldFunction()` - 已在 v2.0 移除

### 不一致项
1. `timeout` 参数：代码默认值 30s，文档写 60s

## 建议操作

1. 为 `parseConfig()` 添加文档
2. 移除 `oldFunction()` 的文档
3. 修正 `timeout` 的默认值说明

是否执行以上修复？[Y/n]
```

---

## 与工作流的集成

### 在 Delivery Workflow 中的位置

```
Design → Plan → Test → Implement → Review → [Docs Sync] → Archive
```

### 触发时机

| 阶段 | 触发条件 | 模式 |
|------|----------|------|
| 实现完成后 | change 影响公共 API | 增量模式 |
| 归档前 | 用户请求 | 增量模式 |
| 独立运行 | 用户显式请求 | 全局模式 |

### 是否每个 change 都要执行？

**不是**。只有满足以下条件的 change 才需要执行：

- 新增/修改/删除公共 API
- 变更用户可见行为
- 修改配置项
- 变更 CLI 命令

**以下情况不需要执行**：

- 纯重构（不影响公共接口）
- Bug 修复（不改变行为）
- 内部实现优化
- 测试代码变更

---

## 如何确保不遗漏

### 1. 在 design.md 中标记

在 design.md 中添加 `[Docs-Required]` 标记：

```markdown
## 变更说明

本次变更添加了新的 `createWidget()` API。[Docs-Required]
```

### 2. 在 tasks.md 中包含文档任务

```markdown
## 任务列表

- [ ] 实现 createWidget API
- [ ] 添加单元测试
- [ ] [Docs] 更新 API.md
- [ ] [Docs] 更新 README.md
```

### 3. 在 review 阶段检查

code-review 时检查是否有未完成的文档任务。

---

## 上下文感知

本 Skill 在执行前自动检测上下文，选择合适的运行模式。

### 检测流程

1. 检测是否在变更包上下文中
2. 检测是否有 `--global` 参数
3. 检测变更包是否影响公共 API

### 本 Skill 支持的模式

| 模式 | 触发条件 | 行为 |
|------|----------|------|
| **增量模式** | 在变更包上下文中 | 只更新本次 change 相关的文档 |
| **全局模式** | 带 --global 参数 | 扫描全部文档并生成差异报告 |
| **检查模式** | 带 --check 参数 | 只检查不修改，输出报告 |

### 检测输出示例

```
检测结果：
- 变更包上下文：存在 (CHG-2024-001)
- 影响公共 API：是 (2 个新增, 1 个修改)
- 运行模式：增量模式
```

---

## MCP 增强

本 Skill 可选使用 MCP 服务增强功能。

### 依赖的 MCP 服务（可选）

| 服务 | 用途 | 超时 |
|------|------|------|
| `mcp__ckb__searchSymbols` | 搜索公共 API | 2s |
| `mcp__ckb__getModuleOverview` | 获取模块概览 | 2s |

### 增强模式 vs 基础模式

| 功能 | 增强模式 | 基础模式 |
|------|----------|----------|
| API 发现 | 自动识别所有导出 | 基于文件 glob 搜索 |
| 影响分析 | 精确的调用关系 | 基于文件名推断 |

### 降级提示

当 MCP 不可用时，输出以下提示：

```
⚠️ CKB 不可用，使用基础模式扫描。
建议：手动指定需要检查的模块路径。
```

---

## 元数据

| 字段 | 值 |
|------|-----|
| Skill 名称 | devbooks-docs-sync |
| 阶段 | Apply（实现后、归档前） |
| 产物 | 更新后的用户文档 |
| 约束 | CON-DOCS-001~003 |

---

*此 Skill 文档遵循 devbooks-* 规范。*
