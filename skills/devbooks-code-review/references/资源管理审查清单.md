# 资源管理审查清单

借鉴 VS Code 的 `code-no-potentially-unsafe-disposables` 和 `code-must-use-super-dispose` 规则。

---

## 1) 资源泄漏常见模式

### 订阅/监听器泄漏

```typescript
// 违规：订阅未取消
class MyComponent {
  private handler = (e: Event) => { /* ... */ };

  initialize() {
    document.addEventListener('click', this.handler);
    // 缺少对应的 removeEventListener
  }
}

// 正确：使用 AbortController
class MyComponent {
  private abortController = new AbortController();

  initialize() {
    document.addEventListener('click', this.handler, {
      signal: this.abortController.signal
    });
  }

  dispose() {
    this.abortController.abort();
  }
}
```

### 定时器泄漏

```typescript
// 违规：定时器未清理
class Poller {
  start() {
    setInterval(() => this.poll(), 1000);
    // 缺少清理逻辑
  }
}

// 正确：保存引用并在 dispose 中清理
class Poller {
  private intervalId?: NodeJS.Timeout;

  start() {
    this.intervalId = setInterval(() => this.poll(), 1000);
  }

  dispose() {
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = undefined;
    }
  }
}
```

### 流/连接泄漏

```typescript
// 违规：流未关闭
async function readFile(path: string) {
  const stream = fs.createReadStream(path);
  const data = await streamToString(stream);
  // 如果 streamToString 抛出异常，流不会关闭
  return data;
}

// 正确：使用 try-finally
async function readFile(path: string) {
  const stream = fs.createReadStream(path);
  try {
    return await streamToString(stream);
  } finally {
    stream.destroy();
  }
}

// 更好：使用 using（TypeScript 5.2+）
async function readFile(path: string) {
  using stream = fs.createReadStream(path);
  return await streamToString(stream);
}
```

---

## 2) DisposableStore 模式

### 基本用法

```typescript
import { Disposable, DisposableStore } from 'vs/base/common/lifecycle';

class MyService extends Disposable {
  // 必须是 readonly
  private readonly _disposables = new DisposableStore();

  constructor() {
    super();

    // 注册订阅到 store
    this._disposables.add(
      eventEmitter.on('change', () => this.handleChange())
    );

    // 注册定时器到 store
    this._disposables.add(
      new IntervalTimer(() => this.poll(), 1000)
    );
  }

  override dispose() {
    this._disposables.dispose();
    super.dispose(); // 必须调用
  }
}
```

### 检查规则

| 规则 | 检测模式 | 严重程度 |
|------|----------|----------|
| DisposableStore 必须 readonly | `private\s+(?!readonly)\s*_?\w*[Dd]isposable` | Error |
| dispose() 必须调用 super | `override\s+dispose\(\).*\{(?![\s\S]*super\.dispose)` | Error |
| 订阅必须注册到 store | `.on\(.*\)` 后无 `.add(` | Warning |
| 测试必须检查泄漏 | 测试文件无 `ensureNoDisposablesAreLeakedInTestSuite` | Warning |

---

## 3) 测试中的资源泄漏检测

### 使用 ensureNoDisposablesAreLeakedInTestSuite

```typescript
import { ensureNoDisposablesAreLeakedInTestSuite } from 'vs/base/test/common/utils';

suite('MyService', () => {
  // 在 suite 开始时启用泄漏检测
  ensureNoDisposablesAreLeakedInTestSuite();

  let service: MyService;

  setup(() => {
    service = new MyService();
  });

  teardown(() => {
    service.dispose(); // 必须清理
  });

  test('should do something', () => {
    // 测试代码
  });
});
```

### 常见测试泄漏

```typescript
// 违规：测试创建的资源未清理
test('creates disposable', () => {
  const disposable = new MyDisposable();
  // 测试结束，disposable 未清理 → 泄漏
});

// 正确：使用 teardown 清理
let disposable: MyDisposable;

setup(() => {
  disposable = new MyDisposable();
});

teardown(() => {
  disposable.dispose();
});
```

---

## 4) 审查检查清单

### 代码审查时必须检查

- [ ] **DisposableStore 声明**
  - 是否使用 `readonly` 修饰？
  - 是否使用 `private`？

- [ ] **dispose() 方法**
  - 是否调用 `super.dispose()`？
  - 是否清理所有已知资源？
  - 是否在基类中定义？

- [ ] **订阅/监听器**
  - 是否注册到 DisposableStore？
  - 是否有对应的取消逻辑？
  - 是否使用 AbortController？

- [ ] **定时器**
  - setInterval 是否有对应的 clearInterval？
  - setTimeout 在组件销毁时是否取消？

- [ ] **流/连接**
  - 是否在 finally 块中关闭？
  - 是否使用 using 语法？

- [ ] **测试**
  - 是否有 `ensureNoDisposablesAreLeakedInTestSuite()`？
  - teardown 是否清理所有创建的资源？

---

## 5) 自动化检测

### ESLint 规则配置

```javascript
// eslint.config.js
module.exports = {
  rules: {
    // 自定义规则：DisposableStore 必须 readonly
    'local/code-no-potentially-unsafe-disposables': 'error',

    // 自定义规则：dispose 必须调用 super
    'local/code-must-use-super-dispose': 'error',
  }
};
```

### grep 检测命令

```bash
# 检测非 readonly 的 DisposableStore
rg 'private\s+(?!readonly)\s*_?\w*[Dd]isposable' --type ts

# 检测 dispose 方法未调用 super.dispose
rg -U 'override\s+dispose\(\).*?\{[^}]*\}' --type ts | grep -v 'super.dispose'

# 检测未清理的 setInterval
rg 'setInterval\(' --type ts -l | xargs -I {} sh -c 'rg -c "clearInterval" {} || echo "Missing clearInterval: {}"'
```

---

## 6) 修复指南

### 添加 DisposableStore

```typescript
// Before
class MyClass {
  private subscription: Subscription;

  constructor() {
    this.subscription = eventEmitter.on('change', () => {});
  }
}

// After
class MyClass extends Disposable {
  private readonly _disposables = new DisposableStore();

  constructor() {
    super();
    this._disposables.add(
      eventEmitter.on('change', () => {})
    );
  }

  override dispose() {
    this._disposables.dispose();
    super.dispose();
  }
}
```

### 添加测试泄漏检测

```typescript
// Before
suite('MyTest', () => {
  test('does something', () => {
    const obj = new MyDisposable();
    // 未清理
  });
});

// After
suite('MyTest', () => {
  ensureNoDisposablesAreLeakedInTestSuite();

  const disposables = new DisposableStore();

  teardown(() => {
    disposables.clear();
  });

  test('does something', () => {
    const obj = disposables.add(new MyDisposable());
    // 会在 teardown 中自动清理
  });
});
```
