# 存量项目：初始化（项目画像 + 基线规格）工作流

适用场景：你在一个已存在的项目里引入“规格化上下文协议”，但 `<truth-root>/` 为空或几乎为空。

目标：一次性补齐“项目画像与约定 + 现状规格基线”，使后续变更能像“从一开始就按协议开发”一样稳定运行。

核心原则：
- **不要一次性写全系统**：先覆盖“对外面”（API/CLI/事件/配置/Schema），再逐步补内核。
- **证据优先**：每条规格都要能指向代码/测试/日志/运行方式；不确定就写 `TBD` + 验证计划。
- **先固化现状，再讨论重构**：基线阶段尽量不引入行为变化；避免“边补 specs 边改行为”导致真理源漂移。

---

## Step 0：确定基线范围（强制）

做三选一（只选一个，避免失控）：
- A) **对外契约优先**：API/事件/Schema/配置格式（最推荐）
- B) **关键链路优先**：登录/支付/下单/编译发布等 1–3 条核心业务链路
- C) **模块边界优先**：依赖方向/分层/禁止循环（配合 C4 + fitness tests）

输出（写进 `<change-root>/<baseline-id>/proposal.md`）：
- In / Out
- 风险与已知未知（<=5 条）
- “本次基线不做什么”（Non-goals）

---

## Step 0.5：一次性产出（推荐做法）

直接使用一条提示词完成“项目画像 + 基线规格 + verification 草案”：
- 本 Skill 的 `references/9 存量项目初始化提示词.md`

该提示词会同时产出：
- `<truth-root>/_meta/project-profile.md`（技术栈/命令/约定/闸门/契约入口）
- `<truth-root>/_meta/glossary.md`（可选：统一语言表）
- `<change-root>/<baseline-id>/...`（proposal/design/specs delta/verification）

---

## Step 1：盘点能力（Capability Inventory）

把存量系统按 MECE 聚类成 3–8 个 capabilities（示例）：
- `auth`、`billing`、`search`、`sync`、`config`、`observability`

每个 capability 至少给出：
- 对外入口（API/CLI/事件/topic）
- 核心数据/Schema
- 依赖方向（调用谁/被谁调用）

产物位置（推荐）：
- `<change-root>/<baseline-id>/design.md`（可选，但强烈建议有一页“现状总结”）

---

## Step 2：写基线 spec deltas（只用 ADDED）

在 `<change-root>/<baseline-id>/specs/<capability>/spec.md` 写**现状规格**：
- 优先只用“新增/ADDED”类 section（具体标题以 `<truth-root>/_meta/project-profile.md` 的格式约定为准）
- 每条 Requirement/需求 至少 1 个 Scenario/场景
- Requirement/Scenario 必须是“可观察”的（输入/输出/错误语义/不变量）

注意：
- 发现不确定：写 `TBD`，并把验证动作加入 `verification.md` 的计划区（不要臆测补齐）。
- 发现明显 bug：不要在基线阶段顺手修；另起一个 change 做修复（避免基线混入行为变化）。

---

## Step 3：补最小验证锚点（建议）

目标不是“全测覆盖”，而是给未来演进留抓手：
- 对外契约：优先 contract tests（schema shape / backward compatibility）
- 关键链路：最小 smoke/integration
- 结构红线：fitness tests（分层/禁止循环/禁止越界依赖）
- 若预计会做重构/迁移：优先加 Snapshot/Golden Master 作为行为指纹

产物位置：
- `<change-root>/<baseline-id>/verification.md`（计划 + 追溯矩阵 + MANUAL-*）
- `tests/**`（按仓库惯例）
- `contracts/**`（如果你维护契约库）

---

## Step 4：合并进当前真理源（<truth-root>/）

把基线 change 的 `<truth-root>/**` 合并进 `<truth-root>/**`：
- 若你的上下文协议提供 archive/merge 命令：用命令完成合并
- 否则：人工合并也可以，但要保持“变更包 -> 当前真理”的单向合并语义

---

## 完成判据（DoD）

- `<truth-root>/` 至少包含 1–3 个核心 capabilities 的 spec.md
- 每个 spec 至少 3–10 条 Requirements（现状级别即可）
- 至少 1 类锚点落地（contract 或 smoke 或 fitness 任选其一）
- 未覆盖部分明确写了 Non-goals + 后续补齐计划
