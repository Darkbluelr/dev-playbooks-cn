# 代码导航策略（四步法）

借鉴 VS Code 的 `copilot-instructions.md`，本文档定义了在存量项目中快速定位代码的标准流程。

---

## 核心原则

> **先理解，后修改**：在修改任何代码之前，必须先理解现有代码的结构和意图。

---

## 四步定位法

### 第一步：语义搜索（Semantic Search）

**目的**：基于意图快速缩小范围

**方法**：
```bash
# 使用模糊搜索工具
rg -i "user.*auth" --type ts
rg -i "login|signin|authenticate" --type ts

# 或使用 IDE 的语义搜索
# VS Code: Cmd+Shift+F → 输入关键词
```

**技巧**：
- 使用业务术语而非技术术语
- 尝试同义词（login/signin/authenticate）
- 搜索注释和文档字符串

### 第二步：精确搜索（Exact Grep）

**目的**：找到具体的函数/类/变量定义

**方法**：
```bash
# 搜索函数定义
rg "function\s+createUser" --type ts
rg "const\s+createUser\s*=" --type ts

# 搜索类定义
rg "class\s+UserService" --type ts

# 搜索接口定义
rg "interface\s+User\b" --type ts

# 搜索导出
rg "export\s+(default\s+)?(function|class|const|interface)\s+\w*User" --type ts
```

**技巧**：
- 使用 `\b` 确保单词边界
- 搜索导出以找到公共 API
- 结合文件路径过滤：`rg "pattern" src/user/`

### 第三步：追踪导入（Trace Imports）

**目的**：理解依赖关系和调用链

**方法**：
```bash
# 找到谁引用了这个模块
rg "from ['\"].*userService['\"]" --type ts
rg "import.*UserService" --type ts

# 找到这个模块引用了谁
rg "^import" src/services/userService.ts

# 使用 IDE 的"查找引用"功能
# VS Code: 右键 → Find All References (Shift+F12)
```

**技巧**：
- 从入口点开始追踪（main.ts, index.ts）
- 注意相对导入 vs 绝对导入
- 检查 re-export（index.ts 中的 `export * from`）

### 第四步：查看测试（Review Tests）

**目的**：理解预期行为和边界条件

**方法**：
```bash
# 找到相关测试文件
rg -l "UserService" tests/ src/**/test/

# 查看测试用例描述
rg "describe\(|it\(|test\(" tests/user.service.test.ts

# 查看 mock 和 fixture
rg "mock|stub|fixture" tests/user.service.test.ts
```

**技巧**：
- 测试是最好的文档
- 查看 `beforeEach` 了解初始化
- 查看 `expect` 了解预期行为
- 边界条件测试揭示隐藏约束

---

## 定位策略选择

| 场景 | 推荐策略 | 原因 |
|------|----------|------|
| 不知道功能在哪 | 语义搜索 → 精确搜索 | 从宽到窄 |
| 知道函数名 | 精确搜索 → 追踪导入 | 直接定位 |
| 理解调用关系 | 追踪导入 → 查看测试 | 上下文理解 |
| 理解预期行为 | 查看测试 | 测试即文档 |
| 修改前验证影响 | 追踪导入 | 影响分析 |

---

## 项目结构识别

### 常见目录结构模式

**分层架构**：
```
src/
├── controllers/   # 入口层
├── services/      # 业务逻辑层
├── repositories/  # 数据访问层
├── models/        # 数据模型
└── utils/         # 工具函数
```

**特性切片架构**：
```
src/
├── user/
│   ├── user.controller.ts
│   ├── user.service.ts
│   └── user.repository.ts
├── order/
│   ├── order.controller.ts
│   └── ...
```

**VS Code 架构**：
```
src/vs/
├── base/          # 基础工具
├── platform/      # 平台服务
├── editor/        # 编辑器
└── workbench/     # 工作台
    ├── browser/   # UI
    ├── services/  # 服务
    └── contrib/   # 贡献模块
```

### 快速识别入口点

```bash
# 查找 main 文件
rg -l "main|bootstrap|app" --type ts -g "*.ts" | head -10

# 查找路由定义
rg "app\.(get|post|put|delete)|router\." --type ts

# 查找服务注册
rg "register|provide|bind" --type ts | head -20
```

---

## 工具推荐

### 命令行工具

| 工具 | 用途 | 安装 |
|------|------|------|
| `rg` (ripgrep) | 快速文本搜索 | `brew install ripgrep` |
| `fd` | 快速文件查找 | `brew install fd` |
| `tree` | 目录结构可视化 | `brew install tree` |
| `bat` | 语法高亮查看 | `brew install bat` |

### IDE 功能

| 功能 | VS Code 快捷键 | 用途 |
|------|----------------|------|
| 全局搜索 | Cmd+Shift+F | 语义搜索 |
| 转到定义 | F12 | 精确定位 |
| 查找引用 | Shift+F12 | 追踪导入 |
| 符号搜索 | Cmd+T | 快速跳转 |
| 文件搜索 | Cmd+P | 快速打开 |

---

## 检查清单

在开始修改代码前，确认已完成：

- [ ] 使用语义搜索找到相关区域
- [ ] 使用精确搜索定位具体定义
- [ ] 追踪导入理解依赖关系
- [ ] 查看测试理解预期行为
- [ ] 识别项目结构模式
- [ ] 确认入口点和调用链
- [ ] 评估修改影响范围
