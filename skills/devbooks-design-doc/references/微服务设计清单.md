# 微服务设计清单

> 适用场景：设计涉及微服务/分布式架构时，使用本清单检查设计完整性。
>
> 本文档为**可选参考**，仅当项目涉及微服务/分布式系统时使用。

---

## 1) RPC 位置透明性陷阱（必须检查）

**核心原则**：远程调用不等于本地函数调用，不要隐藏复杂度。

### 1.1 设计文档必须声明

- [ ] **超时策略**：每个 RPC 调用的超时时间（建议 1-5 秒）
- [ ] **重试策略**：最大重试次数、重试间隔、指数退避
- [ ] **降级方案**：依赖服务不可用时的行为（返回默认值/缓存/错误码）
- [ ] **熔断阈值**：失败率达到多少时触发熔断（建议 50%）

### 1.2 反模式检查

| 反模式 | 问题 | 正确做法 |
|--------|------|----------|
| 无超时 RPC | 一个慢服务拖垮整条链路 | 显式设置超时，建议 1-5 秒 |
| 无限重试 | 重试风暴压垮下游 | 最多 3 次，使用指数退避 |
| 同步链式调用 | A→B→C→D 延迟叠加 | 异步化或并行调用 |
| 隐藏远程调用 | 调用方不知道这是网络 IO | 接口名/返回类型体现"可失败" |

### 1.3 Test Owner 检查项

- [ ] 测试覆盖"依赖服务超时"场景（mock 超时）
- [ ] 测试覆盖"依赖服务返回错误"场景
- [ ] 测试覆盖"熔断后的降级行为"
- [ ] 测试覆盖"重试逻辑"（验证最大重试次数）

---

## 2) 分布式故障影响评估

### 2.1 故障模式清单

| 故障类型 | 影响范围 | 检测方式 | 恢复策略 |
|----------|----------|----------|----------|
| 网络分区 | 服务 A 无法访问服务 B | 健康检查超时 | 熔断 + 降级 |
| 节点宕机 | 单节点服务中断 | 心跳检测失败 | 负载均衡切换 |
| 响应变慢 | 链路延迟增加 | p99 延迟告警 | 限流 + 排队 |
| 数据不一致 | 多副本数据不同步 | 对账任务 | 重试 + 补偿 |

### 2.2 设计文档必须声明

- [ ] 本次变更涉及哪些服务间依赖？
- [ ] 每个依赖的故障影响范围是什么？
- [ ] 故障时的用户可见行为是什么？
- [ ] 是否需要补充故障演练（Chaos Engineering）？

---

## 3) 链路追踪（Distributed Tracing）

### 3.1 设计要求

- [ ] 所有 RPC 调用必须传递 `trace_id`
- [ ] 日志必须包含 `trace_id` 字段
- [ ] 事件/消息必须包含 `trace_id` 字段

### 3.2 实现检查

```
请求头传递: X-Trace-Id / X-Request-Id
日志格式: {"trace_id": "xxx", "message": "...", "timestamp": "..."}
消息包含: {"trace_id": "xxx", "event_type": "...", "payload": {...}}
```

### 3.3 Test Owner 检查项

- [ ] 测试验证"跨服务调用时 trace_id 被正确传递"
- [ ] 测试验证"日志包含 trace_id 字段"
- [ ] 测试验证"异常日志可通过 trace_id 追溯到原始请求"

---

## 4) 服务间契约管理

### 4.1 契约定义要求

- [ ] 使用 OpenAPI/Proto/AsyncAPI 定义服务契约
- [ ] 契约文件纳入版本控制
- [ ] 契约变更需要走兼容性检查

### 4.2 契约测试要求

- [ ] Provider 侧有契约测试（验证实现符合契约）
- [ ] Consumer 侧有契约测试（验证消费者假设正确）
- [ ] 契约变更时双方测试都运行

### 4.3 破坏性变更处理

- [ ] 禁止直接删除已发布 API
- [ ] 新版本与旧版本并行至少 2 个发布周期
- [ ] 提供迁移指南和弃用时间表

---

## 5) exactly-once 与幂等性

### 5.1 消息处理语义选择

| 语义 | 适用场景 | 实现复杂度 |
|------|----------|------------|
| at-most-once | 日志、监控（允许丢失） | 低 |
| at-least-once | 通知、统计（允许重复） | 中 |
| exactly-once | 支付、订单（不允许丢失或重复） | 高 |

### 5.2 exactly-once 实现清单

- [ ] 消息包含唯一 `message_id`
- [ ] 消费者记录已处理的 `message_id`（数据库/Redis）
- [ ] 重复消息直接返回成功（幂等处理）
- [ ] 测试覆盖"同一消息消费 3 次，只执行 1 次"

### 5.3 Test Owner 检查项

- [ ] 测试验证"消息重复时不产生重复副作用"
- [ ] 测试验证"消息丢失时能重试成功"
- [ ] 测试验证"部分失败时能正确补偿"

---

## 6) 设计文档模板补充

在 `design.md` 的目标架构章节，增加以下小节：

```markdown
### 微服务设计约束（如适用）

#### 服务依赖图
- 本服务 → 依赖服务 A（超时 3s，重试 2 次，降级返回空列表）
- 本服务 → 依赖服务 B（超时 5s，重试 0 次，降级返回缓存）

#### 故障模式与降级
| 故障场景 | 用户可见行为 | 恢复策略 |
|----------|--------------|----------|
| 服务 A 不可用 | 显示"暂无数据" | 熔断 60 秒后重试 |
| 服务 B 响应慢 | 使用缓存数据 | p99 > 1s 时触发限流 |

#### 链路追踪要求
- 所有 API 必须传递 `X-Trace-Id`
- 日志格式：JSON，必须包含 `trace_id`
```
