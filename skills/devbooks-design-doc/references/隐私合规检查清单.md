# Telemetry 隐私合规检查项

借鉴 VS Code 的 `telemetry.instructions.md`，本文档定义了埋点/遥测数据的隐私合规要求。

---

## 1) GDPR 分类要求

当 design.md 或 spec-delta 涉及埋点时，**必须**填写以下字段：

```markdown
## Telemetry / 埋点设计

### GDPR Classification

| 字段 | 值 | 说明 |
|------|-----|------|
| **owner** | @username | 数据所有者（必须是团队成员） |
| **isMeasurement** | true/false | 是否为度量数据（非 PII） |
| **purpose** | PerformanceAndHealth / BusinessInsight / FeatureInsight | 收集目的 |
| **classification** | SystemMetaData / CallstackOrException / EndUserPseudonymizedInformation | 数据类型 |
| **retention** | 90d / 1y / permanent | 数据保留期限 |
| **gdprRequired** | true/false | 是否需要用户同意 |

### 埋点事件定义

| 事件名 | 触发时机 | 数据字段 | 分类 |
|--------|----------|----------|------|
| feature.used | 用户使用功能 X 时 | `{ featureId, duration }` | SystemMetaData |
| error.occurred | 发生异常时 | `{ errorCode, stack }` | CallstackOrException |
```

---

## 2) 数据分类说明

### SystemMetaData（系统元数据）

**定义**：不涉及用户身份的系统信息

**允许收集**：
- 操作系统版本
- 应用版本
- 功能开关状态
- 性能指标（延迟、内存）
- 匿名的使用频率

**示例**：
```typescript
// 合规：系统元数据
telemetry.log('app.startup', {
  version: '1.0.0',
  os: 'darwin',
  memoryUsage: process.memoryUsage().heapUsed,
});
```

### CallstackOrException（调用栈或异常）

**定义**：错误信息和调用栈

**允许收集**：
- 错误代码
- 错误消息（需脱敏）
- 调用栈（需脱敏文件路径）

**脱敏要求**：
- 移除用户名：`/Users/john/` → `/Users/<username>/`
- 移除项目路径：`/project/secret/` → `<project>/`
- 移除敏感文件名：`credentials.json` → `<sensitive>`

**示例**：
```typescript
// 合规：脱敏后的异常
telemetry.logError('app.error', {
  errorCode: 'E001',
  message: sanitizeMessage(error.message),
  stack: sanitizeStack(error.stack),
});
```

### EndUserPseudonymizedInformation（终端用户假名化信息）

**定义**：经过假名化处理的用户信息

**要求**：
- 必须使用单向哈希
- 不可逆向还原
- 需要用户同意

**示例**：
```typescript
// 合规：假名化用户 ID
telemetry.log('user.action', {
  hashedUserId: sha256(userId + salt), // 单向哈希
  action: 'click',
});
```

### PublicNonPersonalData（公开非个人数据）

**定义**：完全公开、不涉及任何个人信息的数据

**允许收集**：
- 公开的配置选项
- 公开的 API 版本
- 公开的功能列表

---

## 3) 禁止收集的数据

| 类型 | 示例 | 原因 |
|------|------|------|
| 明文 PII | 姓名、邮箱、电话 | 直接识别用户 |
| 位置信息 | GPS、IP 地址 | 间接识别用户 |
| 文件内容 | 用户文档、代码 | 敏感数据 |
| 密码/令牌 | API keys、密码 | 安全风险 |
| 健康信息 | 医疗数据 | 敏感数据 |
| 财务信息 | 银行卡号 | 敏感数据 |

**检测规则**：
```bash
# 检测可能的 PII 收集
rg "email|phone|name|address|ip" --type ts -g "*telemetry*"
rg "password|token|secret|key" --type ts -g "*telemetry*"
```

---

## 4) 事件命名规范

### 常规事件（publicLog2）

用于正常的功能使用和性能度量：

```typescript
// 命名格式：<domain>.<action>
publicLog2<{ duration: number }>('editor.opened', { duration: 123 });
publicLog2<{ count: number }>('search.performed', { count: 10 });
```

### 异常事件（publicLogError2）

用于错误和异常情况：

```typescript
// 命名格式：<domain>.error 或 <domain>.failed
publicLogError2<{ code: string }>('editor.error', { code: 'E001' });
publicLogError2<{ reason: string }>('save.failed', { reason: 'disk_full' });
```

---

## 5) Code Review 检查清单

当审查涉及埋点的代码时：

### 必须检查

- [ ] **GDPR 分类是否完整？**
  - owner 是否指定？
  - classification 是否正确？
  - purpose 是否明确？

- [ ] **数据是否脱敏？**
  - 文件路径是否移除用户名？
  - 错误消息是否过滤敏感信息？
  - 是否存在明文 PII？

- [ ] **命名是否规范？**
  - 事件名是否符合 `<domain>.<action>` 格式？
  - 错误事件是否使用 `publicLogError2`？

- [ ] **用户同意是否处理？**
  - 需要同意的数据是否检查了 `telemetryLevel`？
  - 是否尊重用户的隐私设置？

### 自动化检查

```bash
# 检查是否有未分类的埋点
rg "publicLog2|telemetry\.log" --type ts | xargs -I {} grep -L "classification" {}

# 检查是否收集敏感数据
rg "(email|phone|password|token)" --type ts -g "*telemetry*"
```

---

## 6) design.md 模板

当 design.md 涉及埋点时，添加以下章节：

```markdown
## Telemetry Impact

### 新增埋点事件

| 事件 | owner | classification | purpose | isMeasurement |
|------|-------|----------------|---------|---------------|
| feature.x.used | @alice | SystemMetaData | FeatureInsight | true |
| feature.x.error | @alice | CallstackOrException | PerformanceAndHealth | false |

### 数据字段定义

```typescript
interface FeatureXUsedEvent {
  duration: number;        // 使用时长（ms）
  success: boolean;        // 是否成功
  // 禁止添加: userId, filePath, etc.
}
```

### 隐私影响评估

- [ ] 不收集 PII
- [ ] 已脱敏敏感路径
- [ ] 已检查 telemetryLevel 设置
- [ ] 已获得 Privacy Review（如需要）
```

---

## 7) 合规审批流程

| 数据类型 | 审批要求 |
|----------|----------|
| SystemMetaData | 无需审批 |
| CallstackOrException | 无需审批（需脱敏） |
| EndUserPseudonymizedInformation | 需要 Privacy Review |
| 任何新的 PII | 需要 Legal Review |

---

## 参考资料

- [GDPR 数据分类指南](https://gdpr.eu/data-protection/)
- [VS Code Telemetry 文档](https://code.visualstudio.com/docs/getstarted/telemetry)
- [Microsoft Privacy Statement](https://privacy.microsoft.com/)
