# 偏离检测与路由协议

> 本协议定义了 skill 执行过程中的偏离检测、记录和路由机制。
> 所有 Apply 阶段的 skill（coder、test-owner、reviewer）必须遵循本协议。

## 核心问题

在长任务（如 coder）执行过程中，可能出现：
1. 计划外的功能修改或新增
2. 发现设计文档的约束需要调整
3. 上下文超出引发 compact，导致偏离信息丢失

**解决方案**：实时落盘 + 完成时检测 + 结构化路由

---

## 完成状态分类（MECE）

每个 skill 结束时，必须识别并声明当前状态：

| 状态码 | 状态 | 含义 | 下一步 |
|:------:|------|------|--------|
| ✅ | COMPLETED | 正常完成，无偏离 | 进入下一个 skill |
| ⚠️ | COMPLETED_WITH_DEVIATION | 完成但有偏离/新增 | 先 design-backport，再下一步 |
| 🔄 | HANDOFF | 需要其他角色处理 | 退回指定 skill |
| ❌ | BLOCKED | 阻塞，需要外部输入 | 记录断点，等待 |
| 💥 | FAILED | 失败，闸门未通过 | 修复后重试 |

### 状态判定规则

```
如果 deviation-log.md 有未回写的记录
  → COMPLETED_WITH_DEVIATION

如果 tasks.md 有未完成项
  → BLOCKED 或 FAILED（取决于原因）

如果发现需要修改 tests/（对于 coder）
  → HANDOFF to test-owner

如果所有任务完成且无偏离
  → COMPLETED
```

---

## 偏离日志协议（Deviation Log Protocol）

### 文件位置

```
<change-root>/<change-id>/deviation-log.md
```

### 文件格式

```markdown
# 偏离日志 (Deviation Log)

> 此文件记录实现过程中发现的所有偏离、新增和临时决策。
> **重要**：Compact 后此文件仍然存在，确保信息不丢失。

## 待回写记录

| 时间 | 类型 | 描述 | 涉及文件 | 已回写 |
|------|------|------|----------|:------:|
| YYYY-MM-DD HH:mm | NEW_FEATURE | 添加了 X 功能 | src/x.ts | ❌ |
| YYYY-MM-DD HH:mm | CONSTRAINT_CHANGE | 超时改为 60s | config.ts | ❌ |
| YYYY-MM-DD HH:mm | DESIGN_GAP | 发现未覆盖的边界情况 | - | ❌ |

## 已回写记录

（design-backport 完成后移动到此处）

| 时间 | 类型 | 描述 | 回写到 |
|------|------|------|--------|
```

### 偏离类型定义

| 类型 | 代码 | 描述 | 示例 |
|------|------|------|------|
| 新增功能 | NEW_FEATURE | 添加了设计中没有的功能 | 新增 warmup() 方法 |
| 约束变更 | CONSTRAINT_CHANGE | 修改了设计中的约束/配置 | 超时从 30s 改为 60s |
| 设计缺口 | DESIGN_GAP | 发现设计未覆盖的场景 | 并发情况未考虑 |
| 接口变更 | API_CHANGE | 公共接口与设计不一致 | 参数增加了 options |
| 依赖变更 | DEPENDENCY_CHANGE | 引入了计划外的依赖 | 新增 lodash |

---

## 实时落盘协议

### 何时写入 deviation-log.md

**必须立即写入**的情况：

1. **添加了新文件/函数**，且不在 tasks.md 中
2. **修改了配置/约束**，且与 design.md 不一致
3. **发现边界情况**，design.md 未覆盖
4. **临时决策**，需要事后确认

### 如何写入

```markdown
## 示例：发现需要新增功能

在 deviation-log.md 中追加一行：

| 2024-01-15 10:30 | NEW_FEATURE | 添加缓存预热功能，提升首次访问性能 | src/cache.ts | ❌ |
```

### Compact 保护

deviation-log.md 是**持久化文件**，不受 compact 影响。即使对话上下文被压缩：
- 文件内容仍然存在
- 下一个 skill 可以读取并处理

---

## 下一步路由规则

### 通用路由表

| 当前 Skill | 完成状态 | 下一步 |
|------------|----------|--------|
| 任意 | COMPLETED_WITH_DEVIATION | `devbooks-design-backport` |
| coder | COMPLETED | `devbooks-code-review` |
| coder | HANDOFF (测试问题) | `devbooks-test-owner` |
| test-owner | COMPLETED | `devbooks-coder` |
| test-owner | HANDOFF (设计问题) | `devbooks-design-backport` |
| code-review | COMPLETED (有 spec delta) | `devbooks-archiver` |
| code-review | COMPLETED (无 spec delta) | 归档完成 |
| 任意 | BLOCKED | 记录断点，等待用户 |
| 任意 | FAILED | 修复后重试当前 skill |

### 路由输出模板

完成 skill 后，必须输出以下格式：

```markdown
## 完成状态

**状态**：[COMPLETED / COMPLETED_WITH_DEVIATION / HANDOFF / BLOCKED / FAILED]

**偏离记录**：[有 N 条 / 无]

## 下一步

**推荐**：`devbooks-xxx skill`

**原因**：[具体原因]

**调用方式**：
运行 devbooks-xxx skill 处理变更 <change-id>
```

---

## 与 design-backport 的交互

### 触发条件

当 deviation-log.md 中有**未回写记录**（已回写=❌）时，必须先执行 design-backport。

### 回写完成标记

design-backport 完成后：
1. 将记录从"待回写"移动到"已回写"
2. 更新"已回写"列为 ✅
3. 记录回写到的具体位置

---

## 检测脚本（可选）

```bash
# 检查是否有未回写的偏离
check_deviation() {
  local change_dir="$1"
  local log_file="${change_dir}/deviation-log.md"

  if [[ ! -f "$log_file" ]]; then
    echo "NO_DEVIATION"
    return 0
  fi

  if grep -q "| ❌" "$log_file"; then
    echo "HAS_PENDING_DEVIATION"
    return 1
  fi

  echo "ALL_BACKPORTED"
  return 0
}
```

---

*此协议是 DevBooks Apply 阶段的核心协议，所有实现类 skill 必须遵循。*
