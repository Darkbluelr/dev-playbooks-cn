# 阶段 2：证据审计清单

> **核心原则**：Test Owner 阶段 2 的职责是**审计证据**，而非重跑测试。

## 触发条件

当用户说"Coder 完成了，请验证"或类似请求时，Test Owner 进入**阶段 2**。

## 前置条件检查

- [ ] `@full` 测试已通过（查看 CI 结果或 `evidence/green-final/`）
- [ ] `verification.md` 已存在且 Status = `Ready` 或 `Implementation Done`
- [ ] AC 覆盖矩阵已建立

## 审计步骤（默认模式）

### 1. 检查证据目录

```bash
# 检查 green-final 目录是否存在
ls -la <change-root>/<change-id>/evidence/green-final/

# 预期内容：
# - test-*.log（测试日志）
# - coverage-*.html（覆盖率报告，可选）
# - commit-hash.txt（代码版本）
```

### 2. 验证 commit hash

```bash
# 读取证据中的 commit hash
cat <change-root>/<change-id>/evidence/green-final/commit-hash.txt

# 对比当前代码版本
git rev-parse HEAD

# 必须一致，否则证据过期
```

### 3. 审计测试日志

检查 `evidence/green-final/test-*.log`：

- [ ] 所有测试都通过（无 FAIL / ERROR）
- [ ] 测试数量与 verification.md 中的 AC 覆盖矩阵一致
- [ ] 没有跳过的测试（SKIP）
- [ ] 没有 Flaky 测试（多次运行结果不一致）

### 4. 验证 AC 覆盖

对照 verification.md 的 AC 覆盖矩阵：

- [ ] 每个 AC 都有对应的测试
- [ ] 测试 ID 与日志中的测试名称匹配
- [ ] 所有 P0 测试都已运行并通过
- [ ] 所有 P1 测试都已运行并通过

### 5. 可选抽样重跑

对高风险 AC 或有疑问的测试进行抽样验证：

```bash
# 重跑特定测试
npm test -- --grep "AC-001"

# 或重跑 @critical 测试
npm test -- --grep "@critical"
```

**何时需要抽样重跑**：
- 证据中的 commit hash 与当前代码不一致
- 测试日志显示异常（如超时、警告）
- AC 描述与测试名称不匹配
- 高风险功能（如支付、权限）

### 6. 勾选 AC 覆盖矩阵

在 verification.md 的 AC 覆盖矩阵中将 `[ ]` 改为 `[x]`：

```markdown
| AC-ID | 描述 | 测试类型 | Test ID | 优先级 | 状态 |
|-------|------|----------|---------|--------|------|
| AC-001 | 用户登录返回 JWT | 单元 | T-001 | P0 | [x] |
| AC-002 | 密码错误返回 401 | 单元 | T-002 | P0 | [x] |
| AC-003 | Token 24小时后过期 | 集成 | T-003 | P1 | [x] |
```

### 7. 设置状态为 Verified

在 verification.md 顶部更新状态：

```markdown
**Status**: Verified
**Verified By**: Test Owner
**Verified At**: 2024-01-15 14:30
**Commit Hash**: abc123def456
```

## 完成状态分类

| 状态码 | 状态 | 判定条件 | 下一步 |
|:------:|------|----------|--------|
| ✅ | PHASE2_VERIFIED | 证据审计通过，AC 矩阵已打勾 | `devbooks-reviewer` |
| ⏳ | PHASE2_WAITING | @full 测试仍在运行 | 等待 CI 完成 |
| ❌ | PHASE2_FAILED | @full 测试未通过 | 通知 Coder 修复 |
| 🔄 | PHASE2_HANDOFF | 发现测试本身有问题 | 修复测试后重新验证 |

## 输出管理

防止大量输出污染 context：

| 场景 | 处理方式 |
|------|----------|
| 测试输出 > 50 行 | 只保留首尾各 10 行 + 失败摘要 |
| Green 证据日志 | 落盘到 `evidence/green-final/`，对话中只引用路径 |
| 大量测试用例列表 | 用表格摘要，不要逐条贴出 |

**示例**：
```
✅ 证据审计通过，AC 矩阵已打勾（15/15）
   详见 evidence/green-final/test-2024-01-15.log
   Commit: abc123def456
   覆盖率：92%
```
