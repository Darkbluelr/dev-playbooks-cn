# verification.md 模板（变更包内）

> 推荐路径：`<change-root>/<change-id>/verification.md`
>
> 目标：把“完成定义”落到可执行锚点与证据上，并提供 `AC-xxx -> Requirement/Scenario -> Test IDs -> Evidence` 的追溯。

---

## 元信息

- Change ID：`<change-id>`
- 状态：`Draft | Ready | Done | Archived`
- 关联：
  - Proposal：`<change-root>/<change-id>/proposal.md`
  - Design：`<change-root>/<change-id>/design.md`
  - Tasks：`<change-root>/<change-id>/tasks.md`
  - Spec deltas：`<change-root>/<change-id>/specs/**`
- 维护者：`<you>`
- 更新时间：`YYYY-MM-DD`
- Test Owner（独立对话）：`<session/agent>`
- Coder（独立对话）：`<session/agent>`
- Red 基线证据：`<change-root>/<change-id>/evidence/`

---

========================
A) 测试计划指令表
========================

### 主线计划区 (Main Plan Area)

- [ ] TP1.1 `<一句话目标>`
  - Why：
  - Acceptance Criteria（引用 AC-xxx / Requirement）：
  - Test Type：`unit | contract | integration | e2e | fitness | static`
  - Non-goals：
  - Candidate Anchors（Test IDs / commands / evidence）：

### 临时计划区 (Temporary Plan Area)

- （留空/按需）

### 断点区 (Context Switch Breakpoint Area)

- 上次进度：
- 当前阻塞：
- 下一步最短路径：

---

========================
B) 追溯矩阵（Traceability Matrix）
========================

> 建议按 AC-xxx 为主键；如果你维护了 Requirements/Scenarios 规格条目，可同时列出对应项。
>
> **追溯完整性要求**：每个 AC 必须能追溯到完整链条 `AC → Requirement/Scenario → Test IDs → Evidence`。

| AC | Requirement/Scenario | Test IDs / Commands | Evidence / MANUAL-* | Status | 因果链完整性 |
|---|---|---|---|---|---|
| AC-001 | `<capability>/Requirement...` | `TEST-...` / `pnpm test ...` | `MANUAL-001` / link | TODO | [ ] 完整 |

### 追溯矩阵完整性检查清单

- [ ] **无孤儿 AC**：每个 AC 都有对应的 Test IDs 或 MANUAL-* 条目
- [ ] **无孤儿测试**：每个 Test ID 都能追溯到 AC 或 Requirement
- [ ] **无无证据 DONE**：每个 Status=DONE 的条目都有 Evidence 链接
- [ ] **Red 基线存在**：`evidence/` 目录包含初始失败证据（证明测试有效）
- [ ] **Green 证据存在**：`evidence/` 目录包含最终通过证据

### 追溯链示例

```
AC-001 (design.md)
  ├── Requirement: REQ-ORDER-001 (specs/order-query/spec.md)
  │   └── Scenario: SC-001 "分页参数非法时返回 400"
  ├── Test IDs:
  │   ├── TEST-001-a: unit test (tests/unit/order_test.py::test_invalid_page)
  │   └── TEST-001-b: contract test (tests/contract/order_api_test.py::test_400)
  └── Evidence:
      ├── Red: evidence/red-baseline-2024-01-05.log
      └── Green: evidence/green-final-2024-01-06.log
```

---

========================
C) 执行锚点（Deterministic Anchors）
========================

### 1) 行为（Behavior）

- unit：
- integration：
- e2e：

### 2) 契约（Contract）

- OpenAPI/Proto/Schema：
- contract tests：

### 3) 结构（Structure / Fitness Functions）

- 分层/依赖方向/禁止循环：

### 4) 静态与安全（Static/Security）

- lint/typecheck/build：
- SAST/secret scan：
- 报告格式：`json|xml`（优先机器可读）
- 质量闸门：复杂度/重复度/依赖规则（如有）

---

========================
D) MANUAL-* 清单（人工/混合验收）
========================

> 只收录“无法稳定自动化”的验收项；每条必须写清证据要求。

- [ ] MANUAL-001 `<验收项>`
  - Pass/Fail 判据：
  - Evidence（截图/录像/链接/日志）：
  - 责任人/签字：

---

========================
E) 风险与降级（可选）
========================

- 风险：
- 降级策略：
- 回滚策略：

========================
F) 结构质量守门记录（可选）
========================

> 若本次变更涉及“代理指标驱动”的要求或潜在结构风险，请记录决策与替代闸门。

- 冲突点：
- 评估影响（内聚/耦合/可测试性）：
- 替代闸门（复杂度/耦合/依赖方向/测试质量）：
- 决策与授权：

========================
G) 价值流与度量（可选，但必须显式填"无"）
========================

> 目的：把"交付更快/更稳/更有价值"的判断落到可观测口径；避免只看局部写码速度。

- 目标价值信号：`<填"无"或写明指标/看板/日志/业务事件>`
- 价值流瓶颈假设（哪里会堵）：`<填"无"或写明 PR review / tests / 发布 / 手工验收 的排队点>`
- 交付与稳定性指标（可选 DORA）：`<填"无"或写明 Lead Time / Deploy Frequency / Change Failure Rate / MTTR 的观测口径>`
- 观测窗口与触发点：`<填"无"或写明上线后多久、观察哪些告警/报表>`
- Evidence：`<填"无"或写明链接/截图/报表路径（建议落到 evidence/）>`

========================
H) 审计与证据管理（推荐）
========================

> 目的：确保变更过程可追溯、可审计，满足合规要求。

### 证据目录结构

```
<change-root>/<change-id>/evidence/
├── red-baseline/           # Red 基线证据（必须）
│   ├── test-failures-<timestamp>.log
│   └── test-failures-<timestamp>.json
├── green-final/            # Green 最终证据（必须）
│   ├── test-results-<timestamp>.log
│   └── test-results-<timestamp>.json
├── performance/            # 性能测试证据（如有）
│   └── benchmark-<timestamp>.json
├── manual-acceptance/      # 人工验收证据（如有）
│   ├── MANUAL-001-screenshot.png
│   └── MANUAL-001-signoff.md
└── audit-log.md           # 审计日志（推荐）
```

### 审计日志模板（audit-log.md）

```markdown
# 变更审计日志

## 元信息
- Change ID: <change-id>
- 创建时间: YYYY-MM-DD HH:MM
- Test Owner: <name/session>
- Coder: <name/session>

## 关键事件记录

| 时间 | 事件 | 操作者 | 证据链接 |
|------|------|--------|----------|
| YYYY-MM-DD HH:MM | Red 基线建立 | Test Owner | evidence/red-baseline/xxx.log |
| YYYY-MM-DD HH:MM | 首次 Green | Coder | evidence/green-final/xxx.log |
| YYYY-MM-DD HH:MM | 人工验收签核 | Reviewer | evidence/manual-acceptance/xxx.md |

## 变更决策记录

| 时间 | 决策内容 | 原因 | 影响范围 |
|------|----------|------|----------|
| YYYY-MM-DD | 调整 AC-002 验收标准 | 发现边界条件遗漏 | tests/unit/xxx_test.py |
```

### 证据采集命令（推荐使用脚本）

```bash
# 采集 Red 基线
change-evidence.sh <change-id> --label red-baseline --project-root "$(pwd)" --change-root <change-root> -- <test-command>

# 采集 Green 最终结果
change-evidence.sh <change-id> --label green-final --project-root "$(pwd)" --change-root <change-root> -- <test-command>

# 采集性能测试结果
change-evidence.sh <change-id> --label performance --project-root "$(pwd)" --change-root <change-root> -- <benchmark-command>
```

### 审计完整性检查清单

- [ ] **Red 基线存在**：`evidence/red-baseline/` 有失败日志
- [ ] **Green 证据存在**：`evidence/green-final/` 有通过日志
- [ ] **时间戳可追溯**：证据文件名包含时间戳
- [ ] **审计日志完整**：`audit-log.md` 记录关键事件
- [ ] **人工验收有签核**：MANUAL-* 条目有责任人签字
