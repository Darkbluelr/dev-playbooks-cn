# 测试分层与运行策略

> **核心原则**：测试分层是解决"慢测试阻塞开发"问题的关键。

## 测试分层标签（必须使用）

| 标签 | 用途 | 谁运行 | 预期耗时 | 何时运行 |
|------|------|--------|----------|----------|
| `@smoke` | 快速反馈，核心路径 | Coder 频繁运行 | 秒级 | 每次代码修改后 |
| `@critical` | 关键功能验证 | Coder 提交前运行 | 分钟级 | 准备提交时 |
| `@full` | 完整验收测试 | CI 异步运行 | 可以慢（小时级） | 后台/CI |

## 各阶段测试运行策略

| 阶段 | 运行什么 | 目的 | 阻塞/异步 |
|------|----------|------|-----------|
| **Test Owner 阶段1** | 只跑**新写的测试** | 确认 Red 状态 | 同步（但只是增量） |
| **Coder 开发中** | `@smoke` | 快速反馈循环 | 同步 |
| **Coder 提交前** | `@critical` | 关键路径验证 | 同步 |
| **Coder 完成时** | `@full`（触发 CI） | 完整验收 | **异步**（不阻塞开发） |
| **Test Owner 阶段2** | **不运行**（审计证据） | 独立验证 | N/A |

## 异步与同步的边界（关键！）

```
✅ 异步的：开发迭代（Coder 完成后可以开始下一个变更，不等 @full）
❌ 同步的：归档门禁（归档必须等 @full 通过）

时间线示例：
T1: Coder 完成实现，触发 @full 异步测试 → 状态 = Implementation Done
T2: Coder 可以开始下一个变更（不阻塞）
T3: @full 测试通过 → 状态 = 可进入阶段2
T4: Test Owner 审计证据 + 打勾 → 状态 = Verified
T5: Code Review → 状态 = Done
T6: 归档（此时 @full 一定已通过）
```

## 测试类型与命名约定

| 测试类型 | 文件命名 | 目录位置 | 预期执行时间 |
|----------|----------|----------|--------------|
| 单元测试 | `*.test.ts` / `*.test.js` | `src/**/test/` 或 `tests/unit/` | < 5s/文件 |
| 集成测试 | `*.integrationTest.ts` | `tests/integration/` | < 30s/文件 |
| E2E 测试 | `*.e2e.ts` / `*.spec.ts` | `tests/e2e/` | < 60s/文件 |
| 契约测试 | `*.contract.ts` | `tests/contract/` | < 10s/文件 |
| 烟雾测试 | `*.smoke.ts` | `tests/smoke/` | 可变 |

## 测试金字塔比例建议

```
        /\
       /E2E\        ≈ 10%（关键用户路径）
      /─────\
     /Integration\  ≈ 20%（模块边界）
    /─────────────\
   /  Unit Tests   \ ≈ 70%（业务逻辑）
  /─────────────────\
```

## 测试优先级

| 优先级 | 定义 | Red 基线要求 |
|--------|------|--------------|
| P0 | 阻塞发布，核心功能 | 必须在 Red 基线中失败 |
| P1 | 重要，应该覆盖 | 应该在 Red 基线中失败 |
| P2 | 锦上添花，可以后补 | Red 基线中可选 |
