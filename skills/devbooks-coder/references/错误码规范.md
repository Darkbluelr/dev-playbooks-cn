# 错误码规范

借鉴 VS Code 错误处理模式，本文档定义了应用程序错误码的标准规范。

---

## 1) 错误码设计原则

### 1.1 可读性

错误码应该人类可读，便于理解和记忆。

```typescript
// 推荐：语义化错误码
'USER_NOT_FOUND'
'INVALID_EMAIL_FORMAT'
'PAYMENT_DECLINED'

// 避免：纯数字或无意义编码
'E10001'
'ERR_X7B2'
```

### 1.2 唯一性

每个错误码在整个系统中应该是唯一的。

```typescript
// 使用前缀区分模块
'AUTH_INVALID_TOKEN'
'AUTH_SESSION_EXPIRED'
'ORDER_NOT_FOUND'
'ORDER_ALREADY_PAID'
```

### 1.3 稳定性

错误码一旦发布就不应该改变含义。

---

## 2) 错误码格式

### 标准格式

```
<MODULE>_<CATEGORY>_<DESCRIPTION>
```

| 部分 | 说明 | 示例 |
|------|------|------|
| MODULE | 模块/服务名 | `AUTH`, `ORDER`, `USER` |
| CATEGORY | 错误类别 | `INVALID`, `NOT_FOUND`, `FAILED` |
| DESCRIPTION | 具体描述 | `TOKEN`, `EMAIL`, `PAYMENT` |

### 示例

```typescript
// 认证模块
'AUTH_INVALID_CREDENTIALS'
'AUTH_TOKEN_EXPIRED'
'AUTH_PERMISSION_DENIED'

// 用户模块
'USER_NOT_FOUND'
'USER_ALREADY_EXISTS'
'USER_INVALID_EMAIL'

// 订单模块
'ORDER_NOT_FOUND'
'ORDER_INVALID_STATUS'
'ORDER_PAYMENT_FAILED'
```

---

## 3) 错误类别

### 标准类别

| 类别 | HTTP 状态码 | 说明 |
|------|------------|------|
| `INVALID` | 400 | 输入验证失败 |
| `UNAUTHORIZED` | 401 | 未认证 |
| `FORBIDDEN` | 403 | 无权限 |
| `NOT_FOUND` | 404 | 资源不存在 |
| `CONFLICT` | 409 | 资源冲突 |
| `RATE_LIMITED` | 429 | 限流 |
| `INTERNAL` | 500 | 内部错误 |
| `UNAVAILABLE` | 503 | 服务不可用 |
| `TIMEOUT` | 504 | 超时 |

### 映射表

```typescript
const ERROR_STATUS_MAP: Record<string, number> = {
  // 400 Bad Request
  'INVALID': 400,
  'VALIDATION': 400,
  'MALFORMED': 400,

  // 401 Unauthorized
  'UNAUTHORIZED': 401,
  'UNAUTHENTICATED': 401,

  // 403 Forbidden
  'FORBIDDEN': 403,
  'PERMISSION': 403,

  // 404 Not Found
  'NOT_FOUND': 404,
  'MISSING': 404,

  // 409 Conflict
  'CONFLICT': 409,
  'DUPLICATE': 409,
  'ALREADY_EXISTS': 409,

  // 429 Too Many Requests
  'RATE_LIMITED': 429,
  'THROTTLED': 429,

  // 500 Internal Server Error
  'INTERNAL': 500,
  'UNEXPECTED': 500,

  // 503 Service Unavailable
  'UNAVAILABLE': 503,
  'MAINTENANCE': 503,

  // 504 Gateway Timeout
  'TIMEOUT': 504,
};
```

---

## 4) 错误类实现

### 基础错误类

```typescript
interface ErrorDetails {
  [key: string]: unknown;
}

class AppError extends Error {
  public readonly code: string;
  public readonly statusCode: number;
  public readonly details?: ErrorDetails;
  public readonly timestamp: string;
  public readonly isOperational: boolean;

  constructor(
    code: string,
    message: string,
    statusCode: number = 500,
    details?: ErrorDetails
  ) {
    super(message);
    this.name = this.constructor.name;
    this.code = code;
    this.statusCode = statusCode;
    this.details = details;
    this.timestamp = new Date().toISOString();
    this.isOperational = true;  // 区分业务错误和系统错误

    Error.captureStackTrace(this, this.constructor);
  }

  toJSON() {
    return {
      code: this.code,
      message: this.message,
      statusCode: this.statusCode,
      details: this.details,
      timestamp: this.timestamp,
    };
  }
}
```

### 具体错误类

```typescript
// 验证错误
class ValidationError extends AppError {
  constructor(field: string, message: string) {
    super(
      `VALIDATION_${field.toUpperCase()}_INVALID`,
      message,
      400,
      { field }
    );
  }
}

// 未找到错误
class NotFoundError extends AppError {
  constructor(resource: string, id: string) {
    super(
      `${resource.toUpperCase()}_NOT_FOUND`,
      `${resource} with id '${id}' not found`,
      404,
      { resource, id }
    );
  }
}

// 认证错误
class AuthenticationError extends AppError {
  constructor(reason: string) {
    super(
      `AUTH_${reason.toUpperCase()}`,
      `Authentication failed: ${reason}`,
      401
    );
  }
}

// 权限错误
class ForbiddenError extends AppError {
  constructor(action: string, resource: string) {
    super(
      'AUTH_PERMISSION_DENIED',
      `You don't have permission to ${action} ${resource}`,
      403,
      { action, resource }
    );
  }
}

// 冲突错误
class ConflictError extends AppError {
  constructor(resource: string, conflict: string) {
    super(
      `${resource.toUpperCase()}_CONFLICT`,
      `${resource} conflict: ${conflict}`,
      409,
      { resource, conflict }
    );
  }
}
```

---

## 5) 错误码注册表

### 中央注册表

```typescript
// errors/registry.ts
export const ERROR_REGISTRY = {
  // ===== 认证模块 (AUTH_*) =====
  AUTH_INVALID_CREDENTIALS: {
    message: 'Invalid username or password',
    statusCode: 401,
    recoverable: true,
  },
  AUTH_TOKEN_EXPIRED: {
    message: 'Authentication token has expired',
    statusCode: 401,
    recoverable: true,
  },
  AUTH_TOKEN_INVALID: {
    message: 'Invalid authentication token',
    statusCode: 401,
    recoverable: false,
  },
  AUTH_PERMISSION_DENIED: {
    message: 'You do not have permission to perform this action',
    statusCode: 403,
    recoverable: false,
  },

  // ===== 用户模块 (USER_*) =====
  USER_NOT_FOUND: {
    message: 'User not found',
    statusCode: 404,
    recoverable: false,
  },
  USER_ALREADY_EXISTS: {
    message: 'User already exists',
    statusCode: 409,
    recoverable: false,
  },
  USER_INVALID_EMAIL: {
    message: 'Invalid email format',
    statusCode: 400,
    recoverable: true,
  },

  // ===== 订单模块 (ORDER_*) =====
  ORDER_NOT_FOUND: {
    message: 'Order not found',
    statusCode: 404,
    recoverable: false,
  },
  ORDER_INVALID_STATUS: {
    message: 'Invalid order status transition',
    statusCode: 400,
    recoverable: false,
  },
  ORDER_PAYMENT_FAILED: {
    message: 'Payment processing failed',
    statusCode: 402,
    recoverable: true,
  },

  // ===== 系统错误 (SYSTEM_*) =====
  SYSTEM_INTERNAL_ERROR: {
    message: 'An internal error occurred',
    statusCode: 500,
    recoverable: false,
  },
  SYSTEM_SERVICE_UNAVAILABLE: {
    message: 'Service temporarily unavailable',
    statusCode: 503,
    recoverable: true,
  },
  SYSTEM_RATE_LIMITED: {
    message: 'Too many requests, please try again later',
    statusCode: 429,
    recoverable: true,
  },
} as const;

export type ErrorCode = keyof typeof ERROR_REGISTRY;
```

### 使用注册表

```typescript
function createError(code: ErrorCode, details?: ErrorDetails): AppError {
  const config = ERROR_REGISTRY[code];
  return new AppError(
    code,
    config.message,
    config.statusCode,
    details
  );
}

// 使用
throw createError('USER_NOT_FOUND', { userId: '12345' });
```

---

## 6) 错误响应格式

### API 错误响应

```typescript
interface ErrorResponse {
  error: {
    code: string;
    message: string;
    details?: ErrorDetails;
    timestamp: string;
    requestId?: string;
    documentation?: string;
  };
}

// 示例响应
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User with id '12345' not found",
    "details": {
      "userId": "12345"
    },
    "timestamp": "2024-01-15T10:30:00.000Z",
    "requestId": "req-abc-123",
    "documentation": "https://docs.example.com/errors/USER_NOT_FOUND"
  }
}
```

### Express 错误处理中间件

```typescript
function errorHandler(
  err: Error,
  req: Request,
  res: Response,
  next: NextFunction
) {
  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      error: {
        code: err.code,
        message: err.message,
        details: err.details,
        timestamp: err.timestamp,
        requestId: req.id,
      }
    });
  }

  // 未知错误
  console.error('Unexpected error:', err);
  return res.status(500).json({
    error: {
      code: 'SYSTEM_INTERNAL_ERROR',
      message: 'An unexpected error occurred',
      timestamp: new Date().toISOString(),
      requestId: req.id,
    }
  });
}
```

---

## 7) 错误文档

### 文档模板

```markdown
## USER_NOT_FOUND

**HTTP 状态码**: 404

**描述**: 请求的用户不存在

**可能原因**:
- 用户 ID 不正确
- 用户已被删除
- 没有访问该用户的权限

**解决方案**:
1. 检查用户 ID 是否正确
2. 确认用户未被删除
3. 确认有足够的访问权限

**示例响应**:
```json
{
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "User with id '12345' not found"
  }
}
```
```

---

## 8) 检查清单

设计错误码时确认：

- [ ] 错误码是否语义化？（人类可读）
- [ ] 错误码是否唯一？（全局不重复）
- [ ] 错误码是否包含模块前缀？
- [ ] HTTP 状态码是否正确映射？
- [ ] 错误消息是否对用户友好？
- [ ] 敏感信息是否脱敏？
- [ ] 是否记录到错误注册表？
- [ ] 是否有文档说明？
