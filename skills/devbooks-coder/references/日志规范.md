# 日志规范

借鉴 VS Code 的日志实践，本文档定义了应用程序日志的标准规范。

---

## 1) 日志级别

### 级别定义

| 级别 | 用途 | 示例 |
|------|------|------|
| `ERROR` | 需要立即关注的错误 | 数据库连接失败、外部 API 错误 |
| `WARN` | 潜在问题，但不影响主流程 | 配置缺失使用默认值、重试成功 |
| `INFO` | 关键业务流程节点 | 用户登录、订单创建、服务启动 |
| `DEBUG` | 开发调试信息 | 函数入参、中间状态 |
| `TRACE` | 详细追踪信息 | 每行数据处理、循环迭代 |

### 级别选择指南

```typescript
// ERROR：系统无法正常工作
logger.error('Database connection failed', { error, retries: 3 });

// WARN：可恢复的问题
logger.warn('Cache miss, falling back to database', { key });

// INFO：业务里程碑
logger.info('User registered', { userId, email });

// DEBUG：开发时有用的信息
logger.debug('Processing request', { params, headers });

// TRACE：非常详细的追踪
logger.trace('Row processed', { rowIndex, data });
```

---

## 2) 日志格式

### 结构化日志

```typescript
// 推荐：结构化日志
logger.info('Order created', {
  orderId: '12345',
  userId: 'user-789',
  amount: 99.99,
  currency: 'USD',
  items: 3
});

// 输出 JSON（便于解析）
{
  "timestamp": "2024-01-15T10:30:00.000Z",
  "level": "INFO",
  "message": "Order created",
  "orderId": "12345",
  "userId": "user-789",
  "amount": 99.99,
  "currency": "USD",
  "items": 3,
  "service": "order-service",
  "traceId": "abc-123-xyz"
}
```

### 必须包含的字段

| 字段 | 说明 | 示例 |
|------|------|------|
| `timestamp` | ISO 8601 格式时间戳 | `2024-01-15T10:30:00.000Z` |
| `level` | 日志级别 | `INFO`, `ERROR` |
| `message` | 人类可读的消息 | `User logged in` |
| `service` | 服务名称 | `user-service` |
| `traceId` | 请求追踪 ID | `abc-123-xyz` |

### 可选字段

| 字段 | 说明 | 何时使用 |
|------|------|---------|
| `userId` | 用户标识 | 有用户上下文时 |
| `requestId` | 请求 ID | HTTP 请求处理 |
| `duration` | 耗时（毫秒） | 性能相关日志 |
| `error` | 错误详情 | ERROR 级别日志 |

---

## 3) 日志内容规范

### 消息格式

```typescript
// 推荐：动词开头，描述发生了什么
logger.info('User logged in', { userId });
logger.info('Order created', { orderId });
logger.info('Payment processed', { paymentId, amount });

// 避免：模糊的消息
logger.info('Done');  // ❌ 什么 done？
logger.info('Error');  // ❌ 什么 error？
logger.info('Processing...');  // ❌ 处理什么？
```

### 上下文数据

```typescript
// 推荐：包含足够的上下文
logger.error('Failed to process payment', {
  orderId: '12345',
  paymentMethod: 'credit_card',
  error: {
    code: 'DECLINED',
    message: 'Card declined by issuer'
  },
  retryCount: 2
});

// 避免：缺少上下文
logger.error('Payment failed');  // ❌ 哪个订单？什么原因？
```

### 敏感数据处理

```typescript
// 禁止：记录敏感数据
logger.info('User login', {
  email: 'user@example.com',
  password: '123456'  // ❌ 绝对禁止！
});

// 正确：脱敏处理
logger.info('User login', {
  email: maskEmail('user@example.com'),  // u***@example.com
  passwordProvided: true
});

// 脱敏工具函数
function maskEmail(email: string): string {
  const [local, domain] = email.split('@');
  return `${local[0]}***@${domain}`;
}

function maskCreditCard(card: string): string {
  return `****-****-****-${card.slice(-4)}`;
}
```

**禁止记录的数据**：

| 类型 | 示例 |
|------|------|
| 密码 | password, secret, token |
| 凭证 | API key, access token |
| 个人信息 | 身份证号、银行卡号 |
| 敏感业务数据 | 完整信用卡号、CVV |

---

## 4) 错误日志规范

### 错误信息结构

```typescript
logger.error('Operation failed', {
  operation: 'createOrder',
  error: {
    name: error.name,
    message: error.message,
    code: error.code,
    stack: error.stack  // 仅在非生产环境
  },
  context: {
    userId: '12345',
    input: sanitize(input)  // 脱敏后的输入
  },
  recovery: 'Will retry in 5 seconds'
});
```

### 错误分类

```typescript
// 可恢复错误（WARN）
logger.warn('Temporary failure, retrying', {
  operation: 'fetchData',
  attempt: 2,
  maxAttempts: 3
});

// 不可恢复错误（ERROR）
logger.error('Critical failure', {
  operation: 'saveData',
  error: error.message,
  action: 'Manual intervention required'
});
```

---

## 5) 性能日志

### 耗时记录

```typescript
// 记录操作耗时
const start = performance.now();
await processOrder(order);
const duration = performance.now() - start;

logger.info('Order processed', {
  orderId: order.id,
  duration: Math.round(duration),  // 毫秒
  durationUnit: 'ms'
});

// 超时警告
if (duration > 1000) {
  logger.warn('Slow operation detected', {
    operation: 'processOrder',
    duration,
    threshold: 1000
  });
}
```

### 批量操作

```typescript
logger.info('Batch processing completed', {
  operation: 'importUsers',
  total: 1000,
  success: 985,
  failed: 15,
  duration: 5230,
  avgPerItem: 5.23
});
```

---

## 6) 日志配置

### 环境配置

| 环境 | 默认级别 | 输出格式 | 堆栈跟踪 |
|------|---------|---------|---------|
| Development | DEBUG | 人类可读 | 完整 |
| Staging | INFO | JSON | 仅 ERROR |
| Production | INFO | JSON | 仅 ERROR |

### 配置示例

```typescript
// logger.config.ts
interface LoggerConfig {
  level: 'error' | 'warn' | 'info' | 'debug' | 'trace';
  format: 'json' | 'pretty';
  includeStack: boolean;
  service: string;
}

const config: LoggerConfig = {
  level: process.env.LOG_LEVEL || 'info',
  format: process.env.NODE_ENV === 'production' ? 'json' : 'pretty',
  includeStack: process.env.NODE_ENV !== 'production',
  service: process.env.SERVICE_NAME || 'app'
};
```

---

## 7) 日志库推荐

### Node.js

```typescript
// 推荐：pino（高性能）
import pino from 'pino';

const logger = pino({
  level: 'info',
  formatters: {
    level: (label) => ({ level: label.toUpperCase() })
  },
  timestamp: () => `,"timestamp":"${new Date().toISOString()}"`
});

// 或：winston（功能丰富）
import winston from 'winston';

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  transports: [
    new winston.transports.Console()
  ]
});
```

### 浏览器

```typescript
// 简单封装
const logger = {
  error: (msg: string, data?: object) =>
    console.error(JSON.stringify({ level: 'ERROR', message: msg, ...data })),
  warn: (msg: string, data?: object) =>
    console.warn(JSON.stringify({ level: 'WARN', message: msg, ...data })),
  info: (msg: string, data?: object) =>
    console.info(JSON.stringify({ level: 'INFO', message: msg, ...data })),
  debug: (msg: string, data?: object) =>
    console.debug(JSON.stringify({ level: 'DEBUG', message: msg, ...data }))
};
```

---

## 8) 检查清单

编写日志时确认：

- [ ] 级别是否正确？（ERROR/WARN/INFO/DEBUG）
- [ ] 消息是否清晰？（动词开头，描述事件）
- [ ] 上下文是否充分？（能定位问题）
- [ ] 敏感数据是否脱敏？
- [ ] 错误日志是否包含堆栈？
- [ ] 性能日志是否包含耗时？
