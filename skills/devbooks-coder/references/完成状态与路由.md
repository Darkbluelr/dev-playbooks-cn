# 完成状态与路由

## 完成状态分类（MECE）

| 状态码 | 状态 | 判定条件 | 下一步 |
|:------:|------|----------|--------|
| ✅ | IMPLEMENTATION_DONE | 快轨测试绿，@full 已触发，无偏离 | 切换到 `[TEST-OWNER]` 等待 @full |
| ⚠️ | IMPLEMENTATION_DONE_WITH_DEVIATION | 快轨绿，deviation-log 有未回写记录 | `devbooks-design-backport` |
| 🔄 | HANDOFF | 发现测试问题需要修改 | 切换到 `[TEST-OWNER]` 模式修复测试 |
| ❌ | BLOCKED | 需要外部输入/决策 | 记录断点，等待用户 |
| 💥 | FAILED | 快轨测试未通过 | 修复后重试 |

## 状态判定流程

```
1. 检查 deviation-log.md 是否有 "| ❌" 记录
   → 有：IMPLEMENTATION_DONE_WITH_DEVIATION

2. 检查是否需要修改 tests/
   → 是：HANDOFF to [TEST-OWNER] 模式

3. 检查快轨测试（@smoke + @critical）是否全部通过
   → 否：FAILED

4. 检查 tasks.md 是否全部完成
   → 否：BLOCKED 或继续实现

5. 以上都通过，触发 @full
   → IMPLEMENTATION_DONE
```

## 路由输出模板（必须使用）

完成 coder 后，**必须**输出以下格式：

```markdown
## 完成状态

**状态**：✅ IMPLEMENTATION_DONE / ⚠️ ... / 🔄 HANDOFF / ❌ BLOCKED / 💥 FAILED

**任务进度**：X/Y 已完成

**快轨测试**：@smoke ✅ / @critical ✅

**@full 测试**：已触发（CI 异步运行中）

**偏离记录**：有 N 条待回写 / 无

## 下一步

**推荐**：切换到 `[TEST-OWNER]` 模式等待 @full / `devbooks-xxx skill`

**原因**：[具体原因]

**注意**：可以开始下一个变更，不需要等待 @full 完成
```

## 具体路由规则

| 我的状态 | 下一步 | 原因 |
|----------|--------|------|
| IMPLEMENTATION_DONE | 切换到 `[TEST-OWNER]` 模式（等 @full） | 快轨绿，等 @full 通过后审计证据 |
| IMPLEMENTATION_DONE_WITH_DEVIATION | `devbooks-design-backport` | 先回写设计 |
| HANDOFF (测试问题) | 切换到 `[TEST-OWNER]` 模式 | Coder 不能修改测试 |
| BLOCKED | 等待用户 | 记录断点区 |
| FAILED | 修复后重试 | 分析失败原因 |

## 关键约束

- Coder **永远不能修改** `tests/**`
- 如发现测试问题，必须切换到 `[TEST-OWNER]` 模式处理
- 如有偏离，必须先 design-backport 再继续
- **Coder 完成后状态是 `Implementation Done`，必须等 @full 通过后才能进入 Test Owner 阶段 2**
- **模式切换替代会话隔离**：使用 `[TEST-OWNER]` / `[CODER]` 标签切换模式
