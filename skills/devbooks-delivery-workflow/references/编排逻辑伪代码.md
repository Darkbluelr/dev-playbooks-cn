# 编排逻辑伪代码

## 主编排函数

```python
def run_delivery_workflow(user_requirement):
    """
    主 Agent 只执行此编排逻辑，不做任何实际工作
    """

    # ==================== 阶段 1: Propose ====================
    change_id = call_subagent("devbooks-proposal-author", {
        "task": "创建变更提案",
        "requirement": user_requirement
    })
    verify_output(f"{change_root}/{change_id}/proposal.md")

    # ==================== 阶段 2: Challenge ====================
    challenge_result = call_subagent("devbooks-challenger", {
        "task": "质疑提案",
        "change_id": change_id
    })
    # 不跳过，即使没有质疑也要运行

    # ==================== 阶段 3: Judge ====================
    judge_result = call_subagent("devbooks-judge", {
        "task": "裁决提案",
        "change_id": change_id,
        "challenge_result": challenge_result
    })
    if judge_result == "REJECTED":
        return "提案被拒绝，流程终止"
    if judge_result == "REVISE":
        # 回到阶段 1，重新编写提案
        return run_delivery_workflow(revised_requirement)
    # judge_result == "APPROVED" 继续

    # ==================== 阶段 4: Design ====================
    call_subagent("devbooks-designer", {
        "task": "创建设计文档",
        "change_id": change_id
    })
    verify_output(f"{change_root}/{change_id}/design.md")

    # ==================== 阶段 5: Spec ====================
    call_subagent("devbooks-spec-owner", {
        "task": "定义规格契约",
        "change_id": change_id
    })
    # specs/ 目录可能为空（无对外契约时）

    # ==================== 阶段 6: Plan ====================
    call_subagent("devbooks-planner", {
        "task": "创建实现计划",
        "change_id": change_id
    })
    verify_output(f"{change_root}/{change_id}/tasks.md")

    # ==================== 阶段 7: Test-Red ====================
    # 必须使用独立 Agent 会话
    call_subagent("devbooks-test-owner", {
        "task": "编写测试并建立 Red 基线",
        "change_id": change_id,
        "isolation": "required"  # 强制隔离
    })
    verify_output(f"{change_root}/{change_id}/verification.md")
    verify_output(f"{change_root}/{change_id}/evidence/red-baseline/")

    # ==================== 阶段 8: Code ====================
    # 必须使用独立 Agent 会话
    call_subagent("devbooks-coder", {
        "task": "按 tasks.md 实现功能",
        "change_id": change_id,
        "isolation": "required"  # 强制隔离
    })

    # ==================== 阶段 9: Test-Review ====================
    test_review_result = call_subagent("devbooks-reviewer", {
        "task": "评审测试质量",
        "change_id": change_id,
        "review_type": "test-review"
    })
    if test_review_result == "REVISE REQUIRED":
        # 回到阶段 7，修复测试问题
        goto_stage(7)

    # ==================== 阶段 10: Code-Review ====================
    code_review_result = call_subagent("devbooks-reviewer", {
        "task": "评审代码质量",
        "change_id": change_id,
        "review_type": "code-review"
    })
    if code_review_result == "REVISE REQUIRED":
        # 回到阶段 8，修复代码问题
        goto_stage(8)

    # ==================== 阶段 11: Green-Verify ====================
    # 必须使用独立 Agent 会话（与阶段 7 相同的 Test Owner）
    call_subagent("devbooks-test-owner", {
        "task": "运行所有测试并收集 Green 证据",
        "change_id": change_id,
        "isolation": "required",
        "phase": "green-verify"
    })
    verify_output(f"{change_root}/{change_id}/evidence/green-final/")

    # ==================== 阶段 12: Archive ====================
    # Archiver 会自动运行 change-check.sh --mode strict
    call_subagent("devbooks-archiver", {
        "task": "执行归档",
        "change_id": change_id
    })

    return "闭环完成"
```
