# 闸门检查与错误处理

## 阶段闸门

| 检查点 | 时机 | 命令 |
|--------|------|------|
| 提案完成 | 阶段 3 后 | `change-check.sh <change-id> --mode proposal` |
| 设计完成 | 阶段 6 后 | `change-check.sh <change-id> --mode apply --role test-owner` |
| 实现完成 | 阶段 10 后 | `change-check.sh <change-id> --mode apply --role coder` |
| 归档前 | 阶段 12 前 | `change-check.sh <change-id> --mode strict` |

## 归档前强制检查项

Archiver 子 Agent 必须验证：

| 检查项 | 要求 |
|--------|------|
| evidence/green-final/ | 存在且非空 |
| verification.md AC 覆盖 | 100%（所有 AC 有对应测试） |
| tasks.md 任务完成率 | 100%（所有 [x] 或 SKIP-APPROVED） |
| change-check.sh --mode strict | 全部通过 |

## 错误处理

### Judge 返回 REVISE

```
阶段 3 返回 REVISE
    ↓
通知用户裁决意见
    ↓
回到阶段 1，携带修改建议
    ↓
重新执行阶段 1-3
```

### Review 返回 REVISE REQUIRED

```
阶段 9（Test-Review）返回 REVISE REQUIRED
    ↓
回到阶段 7，修复测试问题
    ↓
重新执行阶段 7-9

阶段 10（Code-Review）返回 REVISE REQUIRED
    ↓
回到阶段 8，修复代码问题
    ↓
重新执行阶段 8-10
```

### Archive 检查失败

```
阶段 12 检查失败
    ↓
输出失败原因（缺失 evidence / AC 未覆盖 / 任务未完成）
    ↓
回到相应阶段修复
    ↓
重新执行到阶段 12
```

## 回退执行流程

```
Test-Review REVISE REQUIRED:
    → 回到阶段 7（Test-Red）
    → 修复测试问题
    → 重新执行阶段 7-9
    → 循环直到 Test-Review 通过

Code-Review REVISE REQUIRED:
    → 回到阶段 8（Code）
    → 修复代码问题
    → 重新执行阶段 8-10
    → 循环直到 Code-Review 通过
```
