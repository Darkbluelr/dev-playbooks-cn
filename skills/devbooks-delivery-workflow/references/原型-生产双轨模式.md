# 原型-生产双轨模式（Prototype-Production Dual Track）

> 来源：《人月神话》第11章"未雨绸缪" — "第一个开发的系统并不合用...为舍弃而计划，无论如何，你一定要这样做。"

## 核心理念

**原型轨道**用于快速验证技术可行性，产出"可抛弃的第一版"。
**生产轨道**用于交付高质量代码，以测试/闸门为完成判据。

两条轨道**物理隔离**，通过显式的"提升"流程衔接。

---

## 何时使用原型轨道

| 场景 | 信号 | 建议 |
|------|------|------|
| 技术不确定 | "不知道这个库能不能用" / "不确定性能够不够" | ✅ 原型 |
| 第一次做 | "第一次做这类功能" / "预期会重写" | ✅ 原型 |
| 探索行为 | "需要观察 API 的实际返回值" | ✅ 原型 |
| 需求明确 | 设计已确定、AC 已定义 | ❌ 直接生产轨道 |
| 小修小补 | Bug 修复、配置调整 | ❌ 直接生产轨道 |

---

## 双轨模式流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Proposal 阶段                              │
│  proposal.md（共用）                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
              ┌───────────────┴───────────────┐
              │                               │
              ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │   原型轨道       │             │   生产轨道       │
    │   (Prototype)    │             │   (Production)   │
    ├─────────────────┤             ├─────────────────┤
    │ prototype/src/   │             │ design.md        │
    │ prototype/       │             │ tasks.md         │
    │   characterization/│           │ verification.md  │
    │ PROTOTYPE.md     │             │ tests/**         │
    ├─────────────────┤             ├─────────────────┤
    │ 表征测试         │             │ 验收测试         │
    │ (记录实际行为)    │             │ (验证设计意图)    │
    │ 无 Red 基线要求   │             │ 必须 Red 基线    │
    └────────┬────────┘             └────────┬────────┘
             │                                │
             │                                │
             ▼                                │
    ┌─────────────────┐                       │
    │ 学习 & 决策      │                       │
    │ 提升 or 丢弃?    │                       │
    └────────┬────────┘                       │
             │                                │
     ┌───────┴───────┐                        │
     ▼               ▼                        │
  [提升]          [丢弃]                      │
     │               │                        │
     ▼               ▼                        │
prototype-promote.sh  删除 prototype/         │
     │               └─────────────────────►──┤
     │                                        │
     └────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   归档阶段       │
                    │   (Archive)      │
                    └─────────────────┘
```

---

## 表征测试 vs 验收测试

| 维度 | 验收测试（Acceptance Test） | 表征测试（Characterization Test） |
|------|---------------------------|----------------------------------|
| **目的** | 断言"应该是什么" | 断言"实际是什么" |
| **来源** | 设计文档 / AC-xxx | 运行观察 |
| **基线** | 必须先 Red | 初始就是 Green |
| **轨道** | 生产轨道 | 原型轨道 |
| **用途** | 验证设计意图 | 记录行为快照 |
| **CI** | 进入主流程 | 标记跳过 / 隔离 |

### 表征测试命名约定

```
# Python
test_characterize_<behavior>.py
@pytest.mark.characterization

# TypeScript/JavaScript
*.characterization.test.ts
describe.skip('characterization: <behavior>')
```

---

## 角色隔离（不变）

原型模式下，角色隔离原则与生产轨道**完全一致**：

| 角色 | 职责 | 禁止 |
|------|------|------|
| Test Owner | 产出表征测试 | 不得与 Coder 共享上下文 |
| Coder | 产出原型代码 | 禁止修改 characterization/ |

---

## 原型提升检查清单

运行 `prototype-promote.sh <change-id>` 前，必须完成：

- [ ] 创建生产级 `design.md`（从原型学习中提炼 What/Constraints/AC-xxx）
- [ ] Test Owner 产出验收测试 `verification.md`（替代表征测试）
- [ ] 完成 `prototype/PROTOTYPE.md` 中的提升检查清单
- [ ] 在 `prototype/PROTOTYPE.md` 的"学习记录"中写明技术发现

---

## 原型丢弃检查清单

如果决定丢弃原型：

- [ ] 记录学习到的关键洞察到 `proposal.md` 的 Decision Log
- [ ] 删除 `prototype/` 目录
- [ ] 可选：保留部分洞察到 `<truth-root>/_meta/lessons-learned/`

---

## 脚本参考

| 脚本 | 用途 | 示例 |
|------|------|------|
| `change-scaffold.sh --prototype` | 创建原型骨架 | `change-scaffold.sh feat-001 --prototype` |
| `prototype-promote.sh` | 提升原型到生产轨道 | `prototype-promote.sh feat-001` |

---

## 常见问题

### Q: 原型代码可以直接用于生产吗？

**不可以**。原型代码物理隔离在 `prototype/src/`，禁止直接落到仓库 `src/`。必须通过 `prototype-promote.sh` 显式提升。

### Q: 表征测试进入 CI 吗？

**不进入**。表征测试使用 `@characterization` 标记，默认跳过。提升时会归档到 `tests/archived-characterization/`。

### Q: 原型模式下需要写 design.md 吗？

**原型阶段不需要**。原型结束后，如果决定提升，再从原型学习中提炼生产级 `design.md`。

### Q: 可以跳过原型直接做生产吗？

**可以**。如果需求明确、技术方案确定，直接走生产轨道（A/B/C/D 阶段）。

---

## 参考文献

- 《人月神话》第11章"未雨绸缪"
- Michael Feathers,《修改代码的艺术》— Characterization Tests
- Martin Fowler, "Is High Quality Software Worth the Cost?"
