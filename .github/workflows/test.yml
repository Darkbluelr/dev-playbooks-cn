# DevBooks Quality Gates CI
# Runs tests and lint checks on every push and pull request

name: Test

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install BATS (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install BATS (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bats-core

      - name: Install shellcheck (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y shellcheck

      - name: Install shellcheck (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install shellcheck

      - name: Install ripgrep (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get install -y ripgrep

      - name: Install ripgrep (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install ripgrep

      - name: Run shellcheck (lint)
        run: make lint

      - name: Run BATS tests
        run: make test

      - name: Check --help support
        run: make help-check
