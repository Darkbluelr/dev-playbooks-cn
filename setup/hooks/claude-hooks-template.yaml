# DevBooks Claude Code Hooks 配置模板
#
# 用途：实现"无感集成"，在每次对话开始时自动注入上下文
#
# 安装方法：
#   1. 将此文件内容添加到 ~/.claude/settings.yaml
#   2. 或将相关 hook 脚本放到 ~/.claude/hooks/ 目录
#
# 参考：https://docs.anthropic.com/claude-code/hooks

# ============================================================
# 方式一：settings.yaml 配置（推荐）
# ============================================================
# 将以下内容添加到 ~/.claude/settings.yaml

hooks:
  # 用户提交 prompt 前执行，输出会作为系统上下文注入
  PreToolUse:
    - matcher: ".*"  # 匹配所有工具调用
      hooks:
        - type: command
          command: |
            # DevBooks 自动上下文检测
            DEVBOOKS_CONTEXT=""

            # 检查 OpenSpec 项目
            if [ -f "openspec/project.md" ]; then
              DEVBOOKS_CONTEXT="$DEVBOOKS_CONTEXT\n[DevBooks] OpenSpec 项目检测到"

              # 检查当前变更包
              if [ -d "openspec/changes" ]; then
                LATEST_CHANGE=$(ls -t openspec/changes 2>/dev/null | head -1)
                if [ -n "$LATEST_CHANGE" ]; then
                  DEVBOOKS_CONTEXT="$DEVBOOKS_CONTEXT\n[DevBooks] 当前变更包: $LATEST_CHANGE"

                  # 检查 tasks.md 进度
                  if [ -f "openspec/changes/$LATEST_CHANGE/tasks.md" ]; then
                    DONE=$(grep -c '^\- \[x\]' "openspec/changes/$LATEST_CHANGE/tasks.md" 2>/dev/null || echo 0)
                    TOTAL=$(grep -c '^\- \[' "openspec/changes/$LATEST_CHANGE/tasks.md" 2>/dev/null || echo 0)
                    DEVBOOKS_CONTEXT="$DEVBOOKS_CONTEXT\n[DevBooks] 任务进度: $DONE/$TOTAL"
                  fi
                fi
              fi
            fi

            # 检查 SCIP 索引
            if [ -f "index.scip" ]; then
              INDEX_AGE=$(( ($(date +%s) - $(stat -f%m index.scip 2>/dev/null || stat -c%Y index.scip 2>/dev/null)) / 3600 ))
              if [ $INDEX_AGE -gt 24 ]; then
                DEVBOOKS_CONTEXT="$DEVBOOKS_CONTEXT\n[DevBooks] 警告: SCIP 索引已过期 ${INDEX_AGE}h，建议重新生成"
              fi
            else
              DEVBOOKS_CONTEXT="$DEVBOOKS_CONTEXT\n[DevBooks] 提示: SCIP 索引不存在，图基分析不可用"
            fi

            # 输出上下文（如果有）
            if [ -n "$DEVBOOKS_CONTEXT" ]; then
              echo -e "$DEVBOOKS_CONTEXT"
            fi

# ============================================================
# 方式二：独立 Hook 脚本
# ============================================================
# 将以下脚本保存到 ~/.claude/hooks/devbooks-context.sh

# --- 文件: ~/.claude/hooks/devbooks-context.sh ---
#!/bin/bash
# DevBooks 自动上下文注入

# 检查是否在 DevBooks 管理的项目中
is_devbooks_project() {
    [ -f "openspec/project.md" ] || [ -f "project.md" ] || [ -f ".devbooks/config.yaml" ]
}

# 获取当前变更包 ID
get_current_change() {
    if [ -d "openspec/changes" ]; then
        ls -t openspec/changes 2>/dev/null | head -1
    fi
}

# 检查热点文件（需要 CKB MCP）
check_hotspots() {
    # 这部分需要 MCP 调用，在 hook 中无法直接执行
    # 但可以检查缓存文件
    if [ -f ".devbooks/cache/hotspots.json" ]; then
        echo "热点文件缓存可用"
    fi
}

# 主逻辑
if is_devbooks_project; then
    echo "=== DevBooks 项目上下文 ==="

    CHANGE_ID=$(get_current_change)
    if [ -n "$CHANGE_ID" ]; then
        echo "当前变更包: $CHANGE_ID"

        # 建议使用的 Skill
        if [ -f "openspec/changes/$CHANGE_ID/tasks.md" ]; then
            echo "建议 Skill: devbooks-coder（按 tasks.md 实现）"
        elif [ -f "openspec/changes/$CHANGE_ID/design.md" ]; then
            echo "建议 Skill: devbooks-implementation-plan（生成 tasks.md）"
        elif [ -f "openspec/changes/$CHANGE_ID/proposal.md" ]; then
            echo "建议 Skill: devbooks-design-doc（生成 design.md）"
        fi
    else
        echo "未检测到活动变更包"
        echo "建议 Skill: devbooks-router（路由下一步）"
    fi

    echo "==========================="
fi
