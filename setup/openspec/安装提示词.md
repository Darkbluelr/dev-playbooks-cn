# DevBooks 完整安装提示词（统一入口）

> **目标**：让 AI 按此文档完成 DevBooks 全部功能的安装，达到与 Augment 相当的开发体验。
>
> **适用场景**：新项目接入 DevBooks、或新用户首次配置环境。

---

## 安装器角色说明

```text
你是"DevBooks 完整安装器（Full Installer）"。你的目标是完成以下所有组件的安装：

1. 全局 Hook（Augment 风格上下文注入）
2. MCP Server 配置（CKB 图分析、DevBooks 工具）
3. OpenSpec 协议集成（可选，如项目使用 OpenSpec）
4. Embedding API（可选，语义搜索增强）
5. 后台索引守护进程（可选）

安装后效果：
- 每次对话自动注入相关代码片段和热点文件
- CKB 图分析工具可用（analyzeImpact/findReferences/getCallGraph）
- DevBooks Skills 可用（devbooks-coder/devbooks-test-owner 等）
- 全局生效，无需每个项目单独配置
```

---

## 第一步：全局 Hook 安装（必需）

### 检查前置条件

```bash
# 检查依赖
command -v jq &>/dev/null && echo "✓ jq 已安装" || echo "✗ 需要安装: brew install jq"
command -v rg &>/dev/null && echo "✓ ripgrep 已安装" || echo "✗ 需要安装: brew install ripgrep"
```

### 执行安装

运行 DevBooks 项目中的安装脚本：

```bash
cd <devbooks-project-root>
./setup/global-hooks/install.sh
```

或手动执行以下步骤：

1. **复制 Hook 脚本**：
```bash
mkdir -p ~/.claude/hooks
cp setup/global-hooks/augment-context-global.sh ~/.claude/hooks/
chmod +x ~/.claude/hooks/augment-context-global.sh
```

2. **配置 settings.json**：

编辑 `~/.claude/settings.json`，确保包含：

```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/hooks/augment-context-global.sh",
            "timeout": 5000
          }
        ]
      }
    ]
  }
}
```

### 验证

```bash
cd /path/to/any/code/project
echo '{"prompt": "分析 MyClass 类"}' | ~/.claude/hooks/augment-context-global.sh | jq .
```

预期输出包含 `hookSpecificOutput.additionalContext`。

---

## 第二步：MCP Server 配置（必需）

### 检查 claude_desktop_config.json 或 ~/.claude.json

MCP Server 配置位于：
- macOS Desktop: `~/Library/Application Support/Claude/claude_desktop_config.json`
- Claude Code CLI: `~/.claude.json`

### 添加必需的 MCP Servers

```json
{
  "mcpServers": {
    "ckb": {
      "command": "npx",
      "args": ["-y", "@anthropic/ckb-mcp-server@latest"],
      "env": {}
    },
    "devbooks": {
      "command": "node",
      "args": ["<devbooks-project-root>/mcp/devbooks-mcp-server/dist/index.js"],
      "env": {}
    },
    "context7": {
      "command": "npx",
      "args": ["-y", "@anthropic/context7-mcp-server@latest"],
      "env": {}
    },
    "task-master": {
      "command": "npx",
      "args": ["-y", "task-master-mcp@latest"],
      "env": {}
    }
  }
}
```

### 验证 MCP Server

在 Claude Code 中运行：
```
/mcp
```

应显示已连接的 MCP Servers 列表。

---

## 第三步：OpenSpec 协议集成（可选）

> 仅当项目使用 OpenSpec 时需要。

### 前置条件

- 项目已完成 OpenSpec 初始化：存在 `openspec/` 且存在 `openspec/project.md`

### 执行安装

参考 `setup/openspec/安装提示词.md` 完成：

1. 创建 `.devbooks/config.yaml`
2. 更新 `openspec/project.md`（追加 DevBooks 规则）
3. 更新根 `AGENTS.md`（追加配置发现块）

### 快捷方式

告诉 AI：
> 请按照 `setup/openspec/安装提示词.md` 完成 OpenSpec 协议集成。

---

## 第四步：Embedding API 配置（可选）

> 启用后可获得语义搜索能力，提升代码片段匹配精度。

### 创建配置文件

在目标项目中创建 `.devbooks/embedding.yaml`：

```yaml
# Embedding API 配置
enabled: true

api:
  # 支持 OpenAI/Azure/本地 Ollama
  provider: openai  # openai | azure | local
  model: text-embedding-3-small
  api_key: ${OPENAI_API_KEY}
  base_url: https://api.openai.com/v1
  timeout: 30
  batch_size: 50

vector_db:
  storage_path: .devbooks/embeddings/
  dimension: 1536
  index_type: flat

search:
  top_k: 5
  similarity_threshold: 0.7
```

### 构建索引

```bash
cd <devbooks-project-root>
./tools/devbooks-embedding.sh build
```

### 启用带 Embedding 的 Hook

将全局 Hook 替换为带 Embedding 版本：

```bash
cp .claude/hooks/augment-context-with-embedding.sh ~/.claude/hooks/augment-context-global.sh
```

---

## 第五步：后台索引守护进程（可选）

> 启用后自动监听文件变化并更新 SCIP 索引。

### 安装索引器

```bash
# TypeScript 项目
npm install -g @anthropic/scip-typescript

# Python 项目
pip install scip-python

# Go 项目
go install github.com/sourcegraph/scip-go@latest
```

### 启动守护进程

```bash
cd <devbooks-project-root>
./tools/devbooks-indexer.sh /path/to/your/project
```

### 设为开机启动（macOS）

```bash
./tools/devbooks-indexer.sh --install /path/to/your/project
```

---

## 安装完成检查清单

执行以下验证，确保所有组件正常工作：

| 检查项 | 验证命令/方法 | 预期结果 |
|--------|--------------|---------|
| 全局 Hook | `echo '{"prompt": "test"}' \| ~/.claude/hooks/augment-context-global.sh` | 返回 JSON 包含 `hookSpecificOutput` |
| MCP CKB | 在 Claude Code 中调用 `mcp__ckb__getStatus` | 显示后端状态 |
| DevBooks MCP | 在 Claude Code 中调用 `mcp__devbooks__*` | 工具可用 |
| OpenSpec 集成 | 检查 `.devbooks/config.yaml` 存在 | 文件存在且格式正确 |
| Embedding（可选）| `./tools/devbooks-embedding.sh status` | 显示索引状态 |
| 索引守护（可选）| `./tools/devbooks-indexer.sh --status` | 显示运行状态 |

---

## 安装后使用说明

### 自动上下文注入

在任意代码项目中提问，自动获得：
- 相关代码片段
- 热点文件列表
- CKB 工具建议

示例：
```
分析 UserService 类的实现
```

### DevBooks Skills

可用的 Skills（无需显式调用，AI 会自动路由）：

| 意图 | 自动使用的 Skill |
|------|-----------------|
| 修复 Bug | `devbooks-impact-analysis` → `devbooks-coder` |
| 新功能 | `devbooks-router` → 完整闭环 |
| 重构 | `devbooks-code-review` → `devbooks-coder` |
| 写测试 | `devbooks-test-owner` |

### @codebase 搜索

```
/codebase 用户认证流程
```

---

## 故障排除

| 问题 | 解决方案 |
|------|---------|
| Hook 不触发 | 检查 `~/.claude/settings.json` 格式是否正确 |
| 返回空内容 | 确认当前目录是代码项目（有 package.json/pyproject.toml 等） |
| MCP 连接失败 | 检查 `~/.claude.json` 中的路径是否正确 |
| Embedding 报错 | 确认 API Key 已设置：`export OPENAI_API_KEY=xxx` |

---

## 版本信息

- DevBooks 版本：请查看 `setup/global-hooks/augment-context-global.sh` 文件头部
- 兼容 Claude Code 版本：最新版本
- 最后更新：2025-01

---

## 快速安装命令（一键）

```bash
# 克隆 DevBooks
git clone <devbooks-repo> ~/dev-playbooks

# 安装全局 Hook
~/dev-playbooks/setup/global-hooks/install.sh

# 完成！
echo "DevBooks 已安装。在任意代码项目中启动 claude 即可使用。"
```
