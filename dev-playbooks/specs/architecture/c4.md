# C4 架构地图

---
owner: C4 Map Maintainer
last_verified: 2026-01-12
status: Active
freshness_check: 3 Months
last_change: redesign-slash-command-routing
archive_verified: 2026-01-12
---

## C1 系统上下文

- 系统：DevBooks / Dev Playbooks
- 用户：使用 Claude Code 的开发者
- 外部系统：npm Registry、MCP Server（示例列表见 `mcp/mcp-servers.md`）

> 变更说明（来源：complete-devbooks-independence）：移除 Codex CLI 支持描述，当前版本仅支持 Claude Code。

### 外部依赖

| 依赖 | 类型 | 用途 | 必需 |
|------|------|------|------|
| CKB MCP Server | MCP | 代码图分析（符号查询、调用链） | 否（可选） |
| ripgrep | CLI 工具 | 关键词搜索 | 是（系统依赖） |
| npm Registry | 包管理 | `create-devbooks` 分发 | 否（可选） |

## C2 容器（目录级）

| 容器 | 作用 | 证据 |
|---|---|---|
| `skills/` | DevBooks Skills 实现与文档（21+ Skills） | `skills/` |
| `scripts/` | 安装与辅助脚本 | `scripts/` |
| `setup/` | 协议集成与安装模板 | `setup/` |
| `bin/` | CLI 入口脚本 | `bin/create-devbooks.js` |
| `templates/` | 项目初始化模板 | `templates/` |
| `mcp/devbooks-mcp-server/` | DevBooks MCP Server 子项目 | `mcp/devbooks-mcp-server/` |
| `tools/` | 辅助工具脚本（复杂度计算、熵度量等） | `tools/` |
| `docs/` | 对外说明文档 | `docs/` |
| `dev-playbooks/` | **集中式管理目录** | `dev-playbooks/` |
| `templates/claude-commands/` | Slash 命令模板（安装时复制到用户项目） | `templates/claude-commands/devbooks/` |

### dev-playbooks/ 容器详情（新增）

> 来源：evolve-devbooks-architecture 变更

| 子目录 | 作用 |
|--------|------|
| `constitution.md` | 项目宪法（不可违背原则） |
| `project.md` | 项目上下文 |
| `specs/` | 真理源 |
| `specs/_staged/` | 暂存层（三层同步模型） |
| `specs/_meta/anti-patterns/` | 反模式库 |
| `changes/` | 变更包 |
| `scripts/` | 项目级脚本覆盖 |

### tools/ 容器详情

| 工具 | 状态 | 说明 |
|------|------|------|
| `devbooks-complexity.sh` | 活跃 | 复杂度分析 |
| `devbooks-entropy-viz.sh` | 活跃 | 熵度量可视化（由 devbooks-entropy-monitor 调用） |

## C3 组件级拆分

### skills/ 组件

| Skill | 阶段 | 职责 | 约束 |
|-------|------|------|------|
| `devbooks-coder` | Apply | 按 tasks.md 实现功能 | 禁止修改 tests/ |
| `devbooks-test-owner` | Apply | 产出 verification.md + tests/ | - |
| `devbooks-test-reviewer` | Apply | 测试质量评审 | 只读 tests/，不修改代码 |
| `devbooks-router` | 路由 | 根据意图选择 Skill | - |

### skills/devbooks-delivery-workflow/scripts/ 组件

> 来源：harden-devbooks-quality-gates + evolve-devbooks-architecture 变更

| 脚本 | 职责 | 调用方 |
|------|------|--------|
| `change-check.sh` | 变更包质量闸门检查（含宪法/适应度检查） | devbooks-router |
| `change-scaffold.sh` | 变更包脚手架 | devbooks-router |
| `prototype-promote.sh` | 原型提升 | 手动调用 |
| `handoff-check.sh` | 角色交接检查 | change-check.sh / 手动 |
| `env-match-check.sh` | 环境匹配检查 | change-check.sh / 手动 |
| `audit-scope.sh` | 审计全量扫描 | 手动调用 |
| `progress-dashboard.sh` | 进度仪表板 | 手动调用 |
| `migrate-to-v2-gates.sh` | v2 迁移工具 | 一次性迁移 |
| `guardrail-check.sh` | 架构守门检查 | CI / 手动 |
| `constitution-check.sh` | 宪法合规检查 | change-check.sh / 手动 |
| `ac-trace-check.sh` | AC 追溯覆盖率检查 | change-check.sh / 手动 |
| `fitness-check.sh` | 架构适应度检查 | change-check.sh / 手动 |
| `spec-preview.sh` | 三层同步：冲突预检 | 手动调用 |
| `spec-stage.sh` | 三层同步：暂存同步 | 手动调用 |
| `spec-promote.sh` | 三层同步：提升到真理层 | 手动调用 |
| `spec-rollback.sh` | 三层同步：回滚 | 手动调用 |
| `migrate-from-openspec.sh` | OpenSpec → DevBooks 迁移 | 一次性迁移 |
| `verify-openspec-free.sh` | OpenSpec 清理验证 | CI / 手动 |
| `verify-slash-commands.sh` | Slash 命令验证 | CI / 手动 |
| `verify-npm-package.sh` | npm 包验证 | CI / 手动 |
| `verify-all.sh` | 验证套件总入口 | CI / 手动 |

### setup/ 组件

```
setup/
├── generic/           # 协议无关模板
│   ├── DevBooks集成模板（协议无关）.md
│   └── 安装提示词.md
└── README.md
```

### templates/claude-commands/devbooks/ 组件

> 来源：redesign-slash-command-routing 变更
> 注意：模板文件，安装时由 create-devbooks CLI 复制到用户项目的 .claude/commands/devbooks/

| 命令 | 触发 Skill | 说明 |
|------|------------|------|
| `router.md` | devbooks-router | 路由入口，生成执行计划 |
| `proposal.md` | devbooks-proposal-author | 创建变更提案 |
| `challenger.md` | devbooks-proposal-challenger | 提案质疑 |
| `judge.md` | devbooks-proposal-judge | 提案裁决 |
| `debate.md` | devbooks-proposal-debate-workflow | 三角对辩工作流 |
| `design.md` | devbooks-design-doc | 创建设计文档 |
| `backport.md` | devbooks-design-backport | 回写设计文档 |
| `plan.md` | devbooks-implementation-plan | 编码计划 |
| `spec.md` | devbooks-spec-contract | 规格与契约定义 |
| `gardener.md` | devbooks-spec-gardener | 规格园丁（归档维护） |
| `test.md` | devbooks-test-owner | 测试负责人 |
| `test-review.md` | devbooks-test-reviewer | 测试评审 |
| `code.md` | devbooks-coder | 实现负责人 |
| `review.md` | devbooks-code-review | 代码评审 |
| `delivery.md` | devbooks-delivery-workflow | 交付验收工作流 |
| `c4.md` | devbooks-c4-map | C4 架构地图 |
| `impact.md` | devbooks-impact-analysis | 影响分析 |
| `entropy.md` | devbooks-entropy-monitor | 熵度量与预警 |
| `federation.md` | devbooks-federation | 跨仓库联邦分析 |
| `bootstrap.md` | devbooks-brownfield-bootstrap | 存量项目初始化 |
| `index.md` | devbooks-index-bootstrap | 索引引导 |

## C4 代码级（关键模块）

### Skills 核心结构

```
skills/devbooks-*/
├── SKILL.md           # Skill 定义与提示词
├── references/        # 参考文档
└── scripts/           # 辅助脚本（可选）
```

### skills/_shared/ 组件

> 来源：redesign-slash-command-routing 变更

| 文件 | 作用 |
|------|------|
| `context-detection-template.md` | 上下文检测标准规则（产物存在性、完整性判断、阶段检测） |
| `mcp-enhancement-template.md` | MCP 增强标准模板（检测方式、超时、降级策略） |

**依赖方向约束**：
- 各 SKILL.md 可引用 `_shared/` 下的共用模板
- 禁止 `_shared/` 反向依赖具体 Skill

## 依赖方向约束

```
上层（使用方）
    │
    skills/ ───────► 工作流
    │
    ├──► config-discovery.sh ──► constitution.md（宪法加载）
    │
    scripts/ ──────► 安装与配置
    │
    setup/ ────────► 协议适配
    │
    tools/ ────────► 辅助工具
    │
下层（被依赖）
```

**禁止反向依赖**：
- tools/ 不应依赖 skills/
- setup/ 不应依赖 dev-playbooks/changes/
- 宪法加载只能通过 config-discovery.sh（FT-004）

---

## Architecture Guardrails

> 来源：harden-devbooks-quality-gates + evolve-devbooks-architecture 变更

### FT-001: 脚本依赖方向

**规则**：独立工具脚本（audit-scope.sh、progress-dashboard.sh）不应依赖 change-check.sh

**检查命令**：
```bash
# 检查 audit-scope.sh 是否引用 change-check.sh
rg "change-check" skills/devbooks-delivery-workflow/scripts/audit-scope.sh && echo "FAIL" || echo "OK"
```

**严重程度**：High

### FT-002: 闸门脚本退出码契约

**规则**：所有闸门检查脚本必须遵守退出码契约（0=成功，1=失败，2=用法错误）

**检查方式**：BATS 测试覆盖

**严重程度**：Critical

### FT-003: 脚本帮助文档

**规则**：所有 scripts/ 下的 .sh 文件必须支持 --help 参数

**检查命令**：
```bash
for script in skills/devbooks-delivery-workflow/scripts/*.sh; do
  $script --help >/dev/null 2>&1 || echo "FAIL: $script"
done
```

**严重程度**：Medium

### FT-004: 宪法加载入口唯一性（新增）

> 来源：evolve-devbooks-architecture 变更

**规则**：宪法加载只能通过 `config-discovery.sh`，禁止在各 Skill 中分散实现。

**检查命令**：
```bash
# 检查 SKILL.md 文件是否直接引用 constitution.md
rg "constitution\.md" skills/*/SKILL.md && echo "FAIL" || echo "OK"
```

**严重程度**：High

### FT-005: 三层同步顺序约束（新增）

> 来源：evolve-devbooks-architecture 变更

**规则**：`spec-promote` 只能在 `spec-stage` 之后调用。

**检查方式**：脚本内置状态检查（检查 _staged/ 目录是否存在对应变更包）

**严重程度**：Critical

### FT-006: OpenSpec 引用禁止（新增）

> 来源：complete-devbooks-independence 变更

**规则**：代码库中不应包含 OpenSpec 引用（排除迁移脚本和历史文档）。

**检查命令**：
```bash
skills/devbooks-delivery-workflow/scripts/verify-openspec-free.sh
```

**严重程度**：High

### FT-007: npm 包纯净性（新增）

> 来源：complete-devbooks-independence 变更

**规则**：`npm pack` 输出不应包含 `changes/` 目录。

**检查命令**：
```bash
npm pack --dry-run 2>&1 | grep -q "changes/" && echo "FAIL" || echo "OK"
```

**严重程度**：High

### FT-008: Skills 数量完整性（新增）

> 来源：complete-devbooks-independence 变更

**规则**：`skills/devbooks-*` 目录数量应 ≥ 20。

**检查命令**：
```bash
skill_count=$(ls -d skills/devbooks-* 2>/dev/null | wc -l)
[[ "$skill_count" -ge 20 ]] && echo "OK" || echo "FAIL"
```

**严重程度**：Medium

### FT-009: Slash 命令完整性（新增）

> 来源：redesign-slash-command-routing 变更

**规则**：`templates/claude-commands/devbooks/` 目录应包含 24 个命令定义文件（21 个核心命令与 Skills 1:1 对应 + 3 个向后兼容命令）。

**检查命令**：
```bash
cmd_count=$(ls templates/claude-commands/devbooks/*.md 2>/dev/null | wc -l)
[[ "$cmd_count" -eq 24 ]] && echo "OK" || echo "FAIL"
```

**严重程度**：Medium
